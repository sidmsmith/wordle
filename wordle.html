<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Wordle</title>
<meta name="theme-color" content="#121213">
<link rel="manifest" href="/manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:"Segoe UI",-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;background:#121213;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100vh;max-height:100vh;padding:clamp(3px,1vh,8px);overflow:hidden}
#game-container{display:flex;flex-direction:column;align-items:center;width:100%;max-width:500px;height:100%;justify-content:flex-start;gap:clamp(2px,0.8vh,6px);overflow:hidden}
h1{font-size:clamp(1.5rem,5vh,2.5rem);font-weight:700;letter-spacing:0.2em;margin:0;text-transform:uppercase;flex-shrink:0}
#board{display:grid;grid-template-columns:repeat(5,1fr);gap:clamp(3px,0.8vw,5px);margin:0;width:100%;max-width:min(350px,90vw);flex-shrink:0}
.tile{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border:2px solid #3a3a3c;background:#121213;color:#fff;font-size:clamp(1.2rem,4.5vh,2rem);font-weight:700;text-transform:uppercase;transition:all 0.15s}
.tile.filled{border-color:#565758}
:root{--clr-correct:#6aaa64;--clr-present:#c9b458;--clr-absent:#3a3a3c}
.tile.correct{background:var(--clr-correct);border-color:var(--clr-correct)}
.tile.present{background:var(--clr-present);border-color:var(--clr-present)}
.tile.absent{background:var(--clr-absent);border-color:var(--clr-absent)}
.tile.flip{animation:flip 0.5s}
@keyframes flip{0%{transform:scaleY(1)}50%{transform:scaleY(0)}100%{transform:scaleY(1)}}
#message{min-height:clamp(30px,4vh,40px);text-align:center;font-size:clamp(0.875rem,2.5vh,1.2rem);margin:0;font-weight:600;flex-shrink:0}
#new-game-btn{background:#6aaa64;color:#fff;border:none;padding:clamp(8px,2vh,12px) clamp(16px,4vw,24px);font-size:clamp(0.9rem,2.5vh,1.1rem);font-weight:600;border-radius:4px;cursor:pointer;margin:0;display:none;flex-shrink:0}
#new-game-btn:hover{background:#5a9a54}
#new-game-btn:active{transform:scale(0.98)}
#keyboard{display:flex;flex-direction:column;gap:clamp(4px,1vh,8px);width:100%;max-width:500px;padding:0 clamp(5px,2vw,10px);flex-shrink:0}
.keyboard-row{display:flex;justify-content:center;gap:clamp(4px,1vw,6px);width:100%}
.keyboard-key{flex:1;max-width:43px;height:clamp(36px,7vh,58px);display:flex;align-items:center;justify-content:center;background:#818384;color:#fff;border:none;border-radius:4px;font-size:clamp(0.7rem,2vh,0.875rem);font-weight:700;text-transform:uppercase;cursor:pointer;user-select:none;touch-action:manipulation;transition:all 0.1s}
.keyboard-key:active{transform:scale(0.95);opacity:0.8}
.keyboard-key.wide{flex:1.5;max-width:none}
.keyboard-key.extra-wide{flex:2;max-width:none}
.keyboard-key.correct{background:var(--clr-correct)}
.keyboard-key.present{background:var(--clr-present)}
.keyboard-key.absent{background:var(--clr-absent)}
/* ── Header bar ───────────────────────────────────────────── */
#header{position:relative;display:flex;align-items:center;justify-content:center;width:100%;flex-shrink:0}
#stats-btn{background:none;border:none;color:#818384;cursor:pointer;padding:4px 6px;display:flex;align-items:center;touch-action:manipulation}
#stats-btn:hover,#stats-btn:active{color:#fff}
#remaining-btn{background:none;border:none;color:#818384;cursor:pointer;padding:4px 6px;font-size:clamp(0.85rem,2.3vh,1.1rem);font-weight:700;line-height:1;touch-action:manipulation}
#remaining-btn:hover,#remaining-btn:active{color:#fff}
#gear-btn{background:none;border:none;color:#818384;cursor:pointer;padding:4px 6px;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
#gear-btn:hover,#gear-btn:active{color:#fff}
#gear-btn.mp-locked{color:#3a3a3c!important;cursor:not-allowed;opacity:0.4}
/* ── Theme color picker ───────────────────────────────────── */
#theme-section{margin-top:10px;padding-top:10px;border-top:1px solid #3a3a3c}
#theme-label{font-size:0.6rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:#565758;text-align:center;margin-bottom:8px}
#theme-rows{display:flex;flex-direction:column;gap:8px}
.theme-row{display:flex;align-items:center;gap:8px}
.theme-default-swatch{width:36px;height:36px;border-radius:4px;flex-shrink:0;border:1px solid #3a3a3c}
.theme-eq{font-size:1rem;color:#565758;flex-shrink:0;line-height:1}
.theme-picker-wrap{position:relative;flex-shrink:0}
.theme-custom-swatch{width:36px;height:36px;border-radius:4px;border:2px solid #565758;cursor:pointer;display:block;padding:0;-webkit-appearance:none;appearance:none;background:none}
.theme-custom-swatch::-webkit-color-swatch-wrapper{padding:0;border-radius:3px}
.theme-custom-swatch::-webkit-color-swatch{border:none;border-radius:3px}
.theme-custom-swatch::-moz-color-swatch{border:none;border-radius:3px}
.theme-lbl{font-size:0.62rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:#9ca3af;flex:1}
#theme-restore{margin-top:8px;background:none;border:1px solid #565758;color:#9ca3af;border-radius:4px;padding:6px 10px;font-size:0.62rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;cursor:pointer;width:100%;touch-action:manipulation}
#theme-restore:hover{border-color:#fff;color:#fff}
/* ── Multiplayer modal ────────────────────────────────────── */
#mp-modal{display:none;position:fixed;inset:0;z-index:300;align-items:center;justify-content:center}
#mp-modal.open{display:flex}
#mp-bd{position:absolute;inset:0;background:rgba(0,0,0,0.82)}
#mp-card{position:relative;background:#1a1a1b;border:1px solid #3a3a3c;border-radius:8px;width:min(92vw,360px);max-height:82vh;display:flex;flex-direction:column;overflow:hidden}
.mp-hdr{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;border-bottom:1px solid #3a3a3c;flex-shrink:0}
.mp-title{font-size:0.72rem;font-weight:700;letter-spacing:0.15em;text-transform:uppercase;color:#9ca3af}
.mp-x{background:none;border:none;color:#818384;cursor:pointer;font-size:1rem;padding:2px 6px;touch-action:manipulation}
.mp-x:hover{color:#fff}
.mp-view{padding:10px 12px;display:flex;flex-direction:column;gap:7px;overflow-y:auto;flex:1}
.mp-hint{font-size:0.6rem;color:#565758;text-align:center;font-style:italic;padding:2px 0}
.mp-sec{font-size:0.57rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:#565758;margin-top:2px}
.mp-row{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#2a2a2c;border:1px solid #3a3a3c;border-radius:4px;cursor:pointer;touch-action:manipulation;user-select:none}
.mp-row.sel{border-color:#538d4e;background:#1b2b1b}
.mp-row:hover{background:#333}
.mp-row-name{font-size:0.8rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:#fff}
.mp-row-check{font-size:0.85rem;color:#538d4e;font-weight:700;opacity:0}
.mp-row.sel .mp-row-check{opacity:1}
.mp-wait-row{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:#2a2a2c;border-radius:4px}
.mp-wait-name{font-size:0.78rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;color:#fff}
.mp-st{font-size:0.6rem;font-weight:700;letter-spacing:0.04em;text-transform:uppercase}
.mp-st.ok{color:#538d4e}.mp-st.wait{color:#b59f3b}.mp-st.no{color:#565758}.mp-st.host{color:#9ca3af}
.mp-inv-banner{background:#2a2a2c;border:1px solid #b59f3b;border-radius:4px;padding:8px 10px;display:flex;flex-direction:column;gap:6px}
.mp-inv-text{font-size:0.75rem;color:#fff;font-weight:600;text-align:center}
.mp-inv-btns{display:flex;gap:6px}
.mp-inv-btns button{flex:1;border:none;border-radius:4px;padding:7px;font-size:0.7rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;cursor:pointer;touch-action:manipulation}
.mp-acc{background:#538d4e;color:#fff}.mp-dec{background:#3a3a3c;color:#9ca3af}
.mp-btn{background:#538d4e;color:#fff;border:none;border-radius:4px;padding:10px;font-size:0.82rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;cursor:pointer;touch-action:manipulation;width:100%;flex-shrink:0;margin:0 0 10px}
.mp-btn:disabled{background:#2a2a2c;color:#565758;cursor:not-allowed}
.mp-btn:not(:disabled):hover{background:#6aaa64}
.mp-txt-btn{background:none;border:none;color:#818384;cursor:pointer;font-size:0.62rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;padding:4px 6px;touch-action:manipulation}
.mp-txt-btn:hover{color:#fff}
/* Winner / notification overlay */
#mp-win-modal{display:none;position:fixed;inset:0;z-index:400;align-items:center;justify-content:center}
#mp-win-modal.open{display:flex}
#mp-win-bg{position:absolute;inset:0;background:rgba(0,0,0,0.92)}
#mp-win-card{position:relative;background:#1a1a1b;border:2px solid #538d4e;border-radius:12px;width:min(88vw,300px);padding:24px 18px 18px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:10px}
#mp-win-card.loss{border-color:#565758}
#mp-win-trophy{font-size:2.4rem;line-height:1}
#mp-win-name{font-size:1.3rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:#fff}
#mp-win-word{font-size:0.7rem;color:#9ca3af;letter-spacing:0.08em;text-transform:uppercase}
#mp-win-sub{font-size:0.6rem;color:#565758;font-style:italic}
#mp-win-rematch{background:#538d4e;color:#fff;border:none;border-radius:4px;padding:9px 0;font-size:0.8rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;cursor:pointer;touch-action:manipulation;width:100%}
#mp-win-close{background:none;border:none;color:#818384;font-size:0.62rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;cursor:pointer;touch-action:manipulation;padding:4px}
/* Header side-groups for balanced centering */
#hdr-left,#hdr-right{display:flex;align-items:center;gap:4px;width:90px;flex-shrink:0}
#hdr-right{justify-content:flex-end}
#mp-btn{background:none;border:none;color:#818384;cursor:pointer;padding:4px 6px;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
#mp-btn:hover{color:#fff}
/* ── Username modal ───────────────────────────────────────── */
#user-modal{display:none;position:fixed;inset:0;z-index:300;align-items:center;justify-content:center}
#user-modal.open{display:flex}
#user-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.8)}
#user-card{position:relative;background:#1a1a1b;border:1px solid #3a3a3c;border-radius:8px;width:min(92vw,340px);display:flex;flex-direction:column;overflow:hidden;padding:16px 16px 14px}
#user-card-title{text-align:center;font-size:0.8rem;font-weight:700;letter-spacing:0.15em;text-transform:uppercase;color:#9ca3af;margin-bottom:12px}
#user-input{width:100%;background:#121213;border:2px solid #3a3a3c;border-radius:4px;color:#fff;font-size:1rem;font-weight:700;letter-spacing:0.08em;padding:8px 10px;text-transform:uppercase;outline:none}
#user-input:focus{border-color:#818384}
#user-warning{font-size:0.65rem;color:#f87171;margin-top:4px;min-height:1em;text-align:center}
#user-chips-label{font-size:0.6rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:#565758;margin:10px 0 5px}
#user-chips{display:flex;flex-wrap:wrap;gap:6px}
.uchip{background:#2a2a2c;border:1px solid #3a3a3c;border-radius:4px;color:#9ca3af;font-size:0.68rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;padding:5px 10px;cursor:pointer;touch-action:manipulation}
.uchip:hover,.uchip:active{background:#3a3a3c;color:#fff}
.uchip.guest{border-style:dashed;margin-top:2px}
#user-divider{border:none;border-top:1px solid #3a3a3c;margin:8px 0 6px}
#diff-section{margin-top:10px;padding-top:10px;border-top:1px solid #3a3a3c}
#diff-label{font-size:0.6rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:#565758;margin-bottom:5px}
#diff-btns{display:flex;border:1px solid #3a3a3c;border-radius:4px;overflow:hidden}
.diff-btn{flex:1;background:#1a1a1b;border:none;border-right:1px solid #3a3a3c;color:#565758;font-size:0.6rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;padding:8px 3px;cursor:pointer;touch-action:manipulation;transition:background 0.15s,color 0.15s}
.diff-btn:last-child{border-right:none}
.diff-btn.active[data-value="easy"]{background:#3b82f6;color:#fff}
.diff-btn.active[data-value="normal"]{background:#538d4e;color:#fff}
.diff-btn.active[data-value="hard"]{background:#d97706;color:#fff}
.diff-btn.active[data-value="superhard"]{background:#ef4444;color:#fff}
#diff-desc{font-size:0.58rem;color:#565758;text-align:center;margin-top:5px;min-height:1.4em;font-style:italic;line-height:1.4}
#user-save{width:100%;margin-top:12px;background:#6aaa64;color:#fff;border:none;border-radius:4px;padding:10px;font-size:0.9rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;touch-action:manipulation}
#user-save:hover{background:#5a9a54}
#user-save:active{transform:scale(0.98)}
/* ── Remaining words modal ────────────────────────────────── */
#words-modal{display:none;position:fixed;inset:0;z-index:200;align-items:center;justify-content:center}
#words-modal.open{display:flex}
#words-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.72)}
#words-card{position:relative;background:#1a1a1b;border:1px solid #3a3a3c;border-radius:8px;width:min(92vw,380px);max-height:72vh;display:flex;flex-direction:column;overflow:hidden}
#words-card-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 12px 9px;border-bottom:1px solid #3a3a3c;flex-shrink:0}
#words-card-hdr span{font-size:0.78rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:#9ca3af}
#words-close{background:none;border:none;color:#818384;font-size:1.1rem;cursor:pointer;padding:2px 4px;line-height:1;touch-action:manipulation}
#words-close:hover{color:#fff}
#words-grid{overflow-y:auto;padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:5px}
.wword{background:#2a2a2c;border-radius:3px;padding:5px 3px;text-align:center;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:#fff;cursor:pointer;user-select:none;touch-action:pan-y}
.wword:hover{background:#3a3a3c}
.wword:active{background:#538d4e;color:#fff}
/* ── Stats overlay ────────────────────────────────────────── */
#stats-page{display:none;position:fixed;inset:0;background:#121213;z-index:100;flex-direction:column;align-items:center;overflow-y:auto}
#stats-page.visible{display:flex}
#stats-hdr{width:100%;max-width:500px;display:flex;align-items:center;justify-content:space-between;padding:clamp(8px,2vh,14px) clamp(8px,2vw,14px);flex-shrink:0;border-bottom:1px solid #3a3a3c}
#stats-hdr h2{font-size:clamp(1rem,4vh,1.4rem);letter-spacing:0.15em;text-align:center;flex:1;text-transform:uppercase}
#stats-back{background:none;border:none;color:#fff;font-size:1.3rem;cursor:pointer;padding:4px 8px;width:40px;touch-action:manipulation}
#stats-msg{text-align:center;padding:20px;color:#9ca3af;font-size:0.85rem;width:100%;max-width:500px}
#stats-cols{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:#3a3a3c;width:100%;max-width:500px}
.scol{background:#121213;padding:clamp(6px,2vw,10px);display:flex;flex-direction:column;gap:3px}
.scol-title{text-align:center;font-size:clamp(0.78rem,2.5vh,0.95rem);font-weight:700;letter-spacing:0.12em;padding-bottom:5px;border-bottom:1px solid #3a3a3c;text-transform:uppercase}
.scol-summary{text-align:center;font-size:clamp(0.6rem,1.7vh,0.75rem);color:#9ca3af;line-height:1.7;margin-bottom:2px;min-height:3.9em}
.scol-summary b{color:#fff;font-size:clamp(0.7rem,2vh,0.85rem)}
.ssec{font-size:clamp(0.55rem,1.4vh,0.65rem);font-weight:700;letter-spacing:0.07em;color:#565758;text-transform:uppercase;margin-top:4px;text-align:center}
.drow{display:flex;align-items:center;gap:3px}
.dlbl{width:11px;text-align:right;flex-shrink:0;color:#9ca3af;font-weight:600;font-size:clamp(0.58rem,1.5vh,0.7rem)}
.dbar-bg{flex:1;height:clamp(12px,1.9vh,16px);background:#3a3a3c;border-radius:2px;overflow:hidden}
.dbar{height:100%;background:#6aaa64;border-radius:2px;min-width:2px;transition:width 0.4s}
.dbar.loss{background:#f87171}
.dpct{width:26px;text-align:right;flex-shrink:0;font-size:clamp(0.53rem,1.3vh,0.65rem);color:#9ca3af}
.srow{display:flex;align-items:center;gap:3px}
.sword{width:35px;text-transform:uppercase;font-weight:700;flex-shrink:0;font-size:clamp(0.5rem,1.3vh,0.6rem);letter-spacing:0.04em}
.sbar-bg{flex:1;height:clamp(10px,1.7vh,14px);background:#3a3a3c;border-radius:2px;overflow:hidden}
.sbar{height:100%;background:#818384;border-radius:2px;min-width:2px;transition:width 0.4s}
.spct{width:26px;text-align:right;flex-shrink:0;font-size:clamp(0.53rem,1.3vh,0.65rem);color:#9ca3af}
/* ── Extra stats sections (below main table) ──────────────────────────── */
#stats-extra{width:100%;max-width:500px}
.xsec{padding:clamp(5px,1.8vw,9px) clamp(8px,2vw,12px);border-top:1px solid #3a3a3c}
.xsec-title{text-align:center;font-size:clamp(0.63rem,1.6vh,0.76rem);font-weight:700;letter-spacing:0.1em;color:#565758;text-transform:uppercase;padding-bottom:5px}
.ppg-table{width:100%;border-collapse:collapse}
.ppg-table th{color:#565758;font-size:clamp(0.53rem,1.3vh,0.63rem);font-weight:700;letter-spacing:0.07em;text-transform:uppercase;padding:2px 4px;text-align:center}
.ppg-table td{padding:2px 4px;text-align:center;font-size:clamp(0.6rem,1.5vh,0.7rem);color:#9ca3af}
.ppg-table td:first-child{font-weight:600;color:#565758}
.ppg-me{color:#fff!important;font-weight:700!important}
.ppg-better{color:#6aaa64!important;font-weight:700!important}
.ppg-worse{color:#f87171!important;font-weight:700!important}
.fw-cols{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:#3a3a3c;margin-top:4px}
.fwcol{background:#121213;padding:clamp(4px,1.5vw,7px)}
.fwcol-hdr{text-align:center;font-size:clamp(0.53rem,1.3vh,0.63rem);font-weight:700;letter-spacing:0.1em;color:#565758;text-transform:uppercase;padding-bottom:3px;border-bottom:1px solid #3a3a3c;margin-bottom:3px}
.fwrow{display:flex;justify-content:space-between;align-items:center;padding:2px 0;font-size:clamp(0.58rem,1.5vh,0.7rem)}
.fwword{text-transform:uppercase;font-weight:700;letter-spacing:0.04em;color:#fff}
.fwavg{color:#9ca3af;font-size:clamp(0.55rem,1.3vh,0.65rem)}
.fwno-data{color:#565758;font-size:clamp(0.55rem,1.3vh,0.65rem);text-align:center;padding:5px 2px;font-style:italic}
/* ── Multiplayer ─────────────────────────────────────────── */
#mp-btn{background:none;border:none;color:#818384;cursor:pointer;padding:4px 6px;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
#mp-btn:hover{color:#fff}
#mp-modal{display:none;position:fixed;inset:0;z-index:300;align-items:center;justify-content:center}
#mp-modal.open{display:flex}
#mp-bd{position:absolute;inset:0;background:rgba(0,0,0,0.82)}
#mp-card{position:relative;background:#1a1a1b;border:1px solid #3a3a3c;border-radius:8px;width:min(92vw,360px);max-height:82vh;display:flex;flex-direction:column;overflow:hidden}
.mp-hdr{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;border-bottom:1px solid #3a3a3c;flex-shrink:0}
.mp-title{font-size:0.72rem;font-weight:700;letter-spacing:0.15em;text-transform:uppercase;color:#9ca3af}
.mp-x{background:none;border:none;color:#818384;cursor:pointer;font-size:1rem;padding:2px 6px;touch-action:manipulation}.mp-x:hover{color:#fff}
.mp-view{padding:10px 12px;display:flex;flex-direction:column;gap:7px;overflow-y:auto;flex:1}
.mp-hint{font-size:0.6rem;color:#565758;text-align:center;font-style:italic;padding:2px 0}
.mp-sec{font-size:0.57rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:#565758;margin-top:2px}
/* Dynamically-rendered player rows (lobby) */
.mp-prow{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#2a2a2c;border:1px solid #3a3a3c;border-radius:4px;cursor:pointer;touch-action:manipulation;user-select:none}
.mp-prow.sel{border-color:#538d4e;background:#1b2b1b}.mp-prow:hover{background:#333}
.mp-prow.unavail{cursor:default;opacity:0.5}.mp-prow.unavail:hover{background:#2a2a2c}
.mp-prow-left{display:flex;align-items:center;gap:8px}
.mp-prow-name{font-size:0.8rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:#fff}
.mp-prow-chk{font-size:0.85rem;color:#538d4e;font-weight:700;opacity:0}
.mp-prow.sel .mp-prow-chk{opacity:1}
.mp-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.mp-dot.available{background:#538d4e}
.mp-dot.playing{background:#b59f3b}
.mp-dot.offline{background:#565758}
.mp-prow-st{font-size:0.55rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:#565758}
.mp-diff-badge{font-size:0.55rem;font-weight:700;letter-spacing:0.04em;padding:1px 4px;border-radius:3px;flex-shrink:0}
.mp-diff-badge.easy{color:#3b82f6;border:1px solid #3b82f6}
.mp-diff-badge.normal{color:#538d4e;border:1px solid #538d4e}
.mp-diff-badge.hard{color:#d97706;border:1px solid #d97706}
.mp-diff-badge.superhard{color:#ef4444;border:1px solid #ef4444}
/* Waiting-room rows */
.mp-wrow{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:#2a2a2c;border-radius:4px}
.mp-wrow-name{font-size:0.78rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;color:#fff}
.mp-wst{font-size:0.6rem;font-weight:700;letter-spacing:0.04em;text-transform:uppercase}
.mp-wst.ok{color:#538d4e}.mp-wst.wait{color:#b59f3b}.mp-wst.no{color:#565758}.mp-wst.hst{color:#9ca3af}
/* Invitation banner (inside lobby) */
.mp-inv-banner{background:#2a2a2c;border:1px solid #b59f3b;border-radius:4px;padding:8px 10px;display:flex;flex-direction:column;gap:6px}
.mp-inv-text{font-size:0.75rem;color:#fff;font-weight:600;text-align:center}
.mp-inv-row{display:flex;gap:6px}
.mp-inv-row button{flex:1;border:none;border-radius:4px;padding:7px;font-size:0.7rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;cursor:pointer;touch-action:manipulation}
.mp-acc-btn{background:#538d4e;color:#fff}.mp-dec-btn{background:#3a3a3c;color:#9ca3af}
/* Action / ghost buttons (matching HTML class names) */
.mp-btn{background:#538d4e;color:#fff;border:none;border-radius:4px;padding:10px;font-size:0.82rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;cursor:pointer;touch-action:manipulation;width:100%;flex-shrink:0}
.mp-btn:disabled{background:#2a2a2c;color:#565758;cursor:not-allowed}
.mp-btn:not(:disabled):hover{background:#6aaa64}
.mp-txt-btn{background:none;border:none;color:#818384;cursor:pointer;font-size:0.62rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;padding:4px 6px;touch-action:manipulation}.mp-txt-btn:hover{color:#fff}
/* Winner overlay */
#mp-win-modal{display:none;position:fixed;inset:0;z-index:400;align-items:center;justify-content:center}
#mp-win-modal.open{display:flex}
#mp-win-bg{position:absolute;inset:0;background:rgba(0,0,0,0.92)}
#mp-win-card{position:relative;background:#1a1a1b;border:2px solid #538d4e;border-radius:12px;width:min(88vw,300px);padding:24px 18px 18px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:10px}
#mp-win-card.loss{border-color:#565758}
#mp-win-trophy{font-size:2.4rem;line-height:1}
#mp-win-name{font-size:1.3rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:#fff}
#mp-win-word{font-size:0.7rem;color:#9ca3af;letter-spacing:0.08em;text-transform:uppercase}
#mp-win-sub{font-size:0.6rem;color:#565758;font-style:italic}
#mp-win-rematch{background:#538d4e;color:#fff;border:none;border-radius:4px;padding:9px 0;font-size:0.8rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;cursor:pointer;touch-action:manipulation;width:100%}
#mp-win-close{background:none;border:none;color:#818384;font-size:0.62rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;cursor:pointer;touch-action:manipulation;padding:4px}
</style>
</head>
<body>
<div id="game-container">
<div id="header">
<div id="hdr-left">
<button id="remaining-btn" aria-label="Remaining words"></button>
<button id="stats-btn" aria-label="Statistics">
<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="6" width="4" height="15" rx="1"/><rect x="17" y="9" width="4" height="12" rx="1"/></svg>
</button>
</div>
<h1>WORDLE</h1>
<div id="hdr-right">
<button id="mp-btn" aria-label="Multiplayer">
<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
</button>
<button id="gear-btn" aria-label="Settings">
<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 15.5A3.5 3.5 0 018.5 12 3.5 3.5 0 0112 8.5a3.5 3.5 0 013.5 3.5 3.5 3.5 0 01-3.5 3.5m7.43-2.92c.04-.34.07-.68.07-1.08s-.03-.74-.07-1.08l2.32-1.8c.21-.17.27-.46.14-.71l-2.2-3.8a.54.54 0 00-.66-.25l-2.74 1.1c-.57-.44-1.18-.81-1.86-1.09l-.42-2.9A.54.54 0 0014 2h-4a.54.54 0 00-.54.46l-.42 2.9c-.68.28-1.29.65-1.86 1.09L4.44 5.36a.54.54 0 00-.66.25l-2.2 3.8a.53.53 0 00.14.71l2.32 1.8C4.03 12.26 4 12.6 4 13s.03.74.07 1.08L1.75 15.88a.54.54 0 00-.14.71l2.2 3.8c.14.25.43.34.66.25l2.74-1.1c.57.44 1.18.81 1.86 1.09l.42 2.9c.08.28.29.47.54.47h4c.25 0 .46-.19.54-.46l.42-2.9c.68-.28 1.29-.65 1.86-1.09l2.74 1.1c.23.09.52 0 .66-.25l2.2-3.8a.54.54 0 00-.14-.71l-2.32-1.8z"/></svg>
</button>
</div>
</div>
<div id="board"></div>
<div id="message"></div>
<button id="new-game-btn">New Game</button>
<div id="keyboard">
<div class="keyboard-row">
<div class="keyboard-key" data-key="Q">Q</div>
<div class="keyboard-key" data-key="W">W</div>
<div class="keyboard-key" data-key="E">E</div>
<div class="keyboard-key" data-key="R">R</div>
<div class="keyboard-key" data-key="T">T</div>
<div class="keyboard-key" data-key="Y">Y</div>
<div class="keyboard-key" data-key="U">U</div>
<div class="keyboard-key" data-key="I">I</div>
<div class="keyboard-key" data-key="O">O</div>
<div class="keyboard-key" data-key="P">P</div>
</div>
<div class="keyboard-row">
<div class="keyboard-key" data-key="A">A</div>
<div class="keyboard-key" data-key="S">S</div>
<div class="keyboard-key" data-key="D">D</div>
<div class="keyboard-key" data-key="F">F</div>
<div class="keyboard-key" data-key="G">G</div>
<div class="keyboard-key" data-key="H">H</div>
<div class="keyboard-key" data-key="J">J</div>
<div class="keyboard-key" data-key="K">K</div>
<div class="keyboard-key" data-key="L">L</div>
</div>
<div class="keyboard-row">
<div class="keyboard-key wide" data-key="ENTER">ENTER</div>
<div class="keyboard-key" data-key="Z">Z</div>
<div class="keyboard-key" data-key="X">X</div>
<div class="keyboard-key" data-key="C">C</div>
<div class="keyboard-key" data-key="V">V</div>
<div class="keyboard-key" data-key="B">B</div>
<div class="keyboard-key" data-key="N">N</div>
<div class="keyboard-key" data-key="M">M</div>
<div class="keyboard-key wide" data-key="BACKSPACE">⌫</div>
</div>
</div>
</div>

<!-- ── Multiplayer Modal ────────────────────────────────────────────────── -->
<div id="mp-modal" role="dialog" aria-modal="true" aria-label="Multiplayer">
<div id="mp-bd"></div>
<div id="mp-card">
  <!-- Lobby view -->
  <div id="mp-v-lobby">
    <div class="mp-hdr">
      <span class="mp-title">MULTIPLAYER</span>
      <button class="mp-x" id="mp-close-btn">✕</button>
    </div>
    <div class="mp-view">
      <div id="mp-inv-area"></div>
      <div id="mp-lobby-status" class="mp-hint">Looking for players...</div>
      <div id="mp-sec-online" class="mp-sec" style="display:none">ONLINE NOW</div>
      <div id="mp-lobby-list"></div>
      <button class="mp-btn" id="mp-invite-btn" disabled>INVITE SELECTED</button>
    </div>
  </div>
  <!-- Waiting view (host) -->
  <div id="mp-v-waiting" style="display:none">
    <div class="mp-hdr">
      <span class="mp-title">WAITING FOR PLAYERS</span>
      <button class="mp-txt-btn" id="mp-cancel-btn">CANCEL</button>
    </div>
    <div class="mp-view">
      <div id="mp-wait-list"></div>
      <button class="mp-btn" id="mp-start-btn" disabled>START GAME</button>
    </div>
  </div>
  <!-- Accepted view (non-host waiting for start) -->
  <div id="mp-v-accepted" style="display:none">
    <div class="mp-hdr">
      <span class="mp-title">GET READY</span>
    </div>
    <div class="mp-view">
      <div id="mp-accepted-msg" class="mp-hint" style="text-align:center;padding:20px 0"></div>
    </div>
  </div>
</div>
</div>

<!-- ── Winner Overlay ───────────────────────────────────────────────────── -->
<div id="mp-win-modal" role="dialog" aria-modal="true">
<div id="mp-win-bg"></div>
<div id="mp-win-card">
  <div id="mp-win-trophy"></div>
  <div id="mp-win-name"></div>
  <div id="mp-win-word"></div>
  <div id="mp-win-sub"></div>
  <button id="mp-win-rematch">REMATCH</button>
  <button id="mp-win-close">BACK TO SOLO</button>
</div>
</div>

<div id="user-modal" role="dialog" aria-modal="true" aria-label="Set username">
<div id="user-backdrop"></div>
<div id="user-card">
  <div id="user-card-title">WHO ARE YOU?</div>
  <input id="user-input" type="text" maxlength="32" autocomplete="off" autocorrect="off" spellcheck="false" placeholder="ENTER NAME">
  <div id="user-warning"></div>
  <div id="user-chips-label">SELECT EXISTING</div>
  <div id="user-chips"></div>
  <div id="diff-section">
    <div id="diff-label">DIFFICULTY</div>
    <div id="diff-btns">
      <button class="diff-btn" data-value="easy">EASY</button>
      <button class="diff-btn" data-value="normal">NORMAL</button>
      <button class="diff-btn" data-value="hard">HARD</button>
      <button class="diff-btn" data-value="superhard">SUPER HARD</button>
    </div>
    <div id="diff-desc"></div>
  </div>
  <div id="theme-section">
    <div id="theme-label">TILE COLORS</div>
    <div id="theme-rows">
      <div class="theme-row">
        <div class="theme-default-swatch" id="thm-def-correct" style="background:#6aaa64"></div>
        <span class="theme-eq">=</span>
        <input type="color" class="theme-custom-swatch" id="thm-correct" value="#6aaa64">
        <span class="theme-lbl">CORRECT</span>
      </div>
      <div class="theme-row">
        <div class="theme-default-swatch" id="thm-def-present" style="background:#c9b458"></div>
        <span class="theme-eq">=</span>
        <input type="color" class="theme-custom-swatch" id="thm-present" value="#c9b458">
        <span class="theme-lbl">PRESENT</span>
      </div>
      <div class="theme-row">
        <div class="theme-default-swatch" id="thm-def-absent" style="background:#3a3a3c"></div>
        <span class="theme-eq">=</span>
        <input type="color" class="theme-custom-swatch" id="thm-absent" value="#3a3a3c">
        <span class="theme-lbl">ABSENT</span>
      </div>
    </div>
    <button id="theme-restore">RESTORE DEFAULTS</button>
  </div>
  <button id="user-save">SAVE</button>
</div>
</div>

<div id="words-modal">
<div id="words-backdrop"></div>
<div id="words-card">
<div id="words-card-hdr">
<span id="words-card-title">Possible Words</span>
<button id="words-close" aria-label="Close">✕</button>
</div>
<div id="words-grid"></div>
</div>
</div>

<div id="stats-page">
<div id="stats-hdr">
<button id="stats-back">&#8592;</button>
<h2>STATISTICS</h2>
<button id="stats-gear" aria-label="Change user" style="background:none;border:none;color:#818384;cursor:pointer;padding:4px 8px;width:40px;display:flex;align-items:center;justify-content:center;touch-action:manipulation">
<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 15.5A3.5 3.5 0 018.5 12 3.5 3.5 0 0112 8.5a3.5 3.5 0 013.5 3.5 3.5 3.5 0 01-3.5 3.5m7.43-2.92c.04-.34.07-.68.07-1.08s-.03-.74-.07-1.08l2.32-1.8c.21-.17.27-.46.14-.71l-2.2-3.8a.54.54 0 00-.66-.25l-2.74 1.1c-.57-.44-1.18-.81-1.86-1.09l-.42-2.9A.54.54 0 0014 2h-4a.54.54 0 00-.54.46l-.42 2.9c-.68.28-1.29.65-1.86 1.09L4.44 5.36a.54.54 0 00-.66.25l-2.2 3.8a.53.53 0 00.14.71l2.32 1.8C4.03 12.26 4 12.6 4 13s.03.74.07 1.08L1.75 15.88a.54.54 0 00-.14.71l2.2 3.8c.14.25.43.34.66.25l2.74-1.1c.57.44 1.18.81 1.86 1.09l.42 2.9c.08.28.29.47.54.47h4c.25 0 .46-.19.54-.46l.42-2.9c.68-.28 1.29-.65 1.86-1.09l2.74 1.1c.23.09.52 0 .66-.25l2.2-3.8a.54.54 0 00-.14-.71l-2.32-1.8z"/></svg>
</button>
</div>
<p id="stats-msg">Loading...</p>
<div id="stats-cols" style="display:none">
<div class="scol" id="col-me"></div>
<div class="scol" id="col-overall"></div>
</div>

<div id="stats-extra" style="display:none">
<div class="xsec">
<div class="xsec-title">Possibilities Per Guess</div>
<table class="ppg-table">
<thead><tr><th>Guess</th><th>Me</th><th>Overall</th></tr></thead>
<tbody id="ppg-body"></tbody>
</table>
</div>
<div class="xsec">
<div class="xsec-title">Best First Words</div>
<div class="fw-cols">
<div class="fwcol"><div class="fwcol-hdr">Me</div><div id="fw-best-me"></div></div>
<div class="fwcol"><div class="fwcol-hdr">Overall</div><div id="fw-best-overall"></div></div>
</div>
</div>
<div class="xsec">
<div class="xsec-title">Worst First Words</div>
<div class="fw-cols">
<div class="fwcol"><div class="fwcol-hdr">Me</div><div id="fw-worst-me"></div></div>
<div class="fwcol"><div class="fwcol-hdr">Overall</div><div id="fw-worst-overall"></div></div>
</div>
</div>
</div>
</div>

<script>
const WORDS=['aback','abaft','abase','abbey','abbot','abhor','abide','abler','abode','abort','about','above','absit','abuse','abuzz','abyss','ached','achoo','acorn','acted','actor','acute','adage','adapt','added','adder','adept','adieu','adlib','admit','admix','adobe','adopt','adore','adorn','adult','aerie','affix','afire','afoot','afore','afoul','after','again','agape','agate','agave','agent','agile','aging','aglow','agony','agora','agree','ahead','ahold','aided','aider','ailed','aimed','aimer','aioli','aired','airer','aisle','alarm','album','alder','alert','algae','alibi','alien','align','alike','alive','alkyl','allay','alley','allot','allow','alloy','aloft','aloha','alone','along','aloof','aloud','alpha','altar','alter','alway','amaze','amber','ambit','amble','amend','amigo','amino','amity','among','amour','amped','ample','amuck','amuse','angel','anger','angle','angry','angst','ankle','annex','annoy','annul','annum','anode','anted','antic','antsy','anvil','aorta','apace','apart','apnea','aport','apple','apply','apron','aptly','arbor','ardor','areal','arena','argon','argue','aries','arise','arity','armed','armor','aroma','arose','array','arrow','arson','artsy','ascot','ashen','aside','asked','asker','askew','aspen','assai','asset','aster','astir','astro','atilt','atoll','atone','attic','audio','audit','auger','aught','aural','avail','avant','avert','avian','avoid','await','awake','award','aware','awash','awful','awing','awoke','axial','axing','axiom','axled','axman','axmen','azure','babel','bacon','baddy','badge','badly','bagel','baggy','baked','baker','baldy','baled','baler','balky','bally','balmy','balsa','banal','bandy','banjo','bared','barer','barfy','barge','baric','barky','barmy','baron','basal','based','baser','basil','basin','batch','bated','bathe','baton','batty','bawdy','bayed','bayou','beach','beady','beaky','beamy','beard','beast','beaut','beaux','beech','beefy','beery','befit','began','begin','begot','begun','beige','being','belay','belch','belie','belle','belly','below','bench','beret','berry','berth','beset','bevel','bezel','bible','bided','bider','bidet','biggy','bigot','biked','biker','bilge','bimbo','binge','bingo','biome','birch','birth','bison','bitch','biter','bitsy','bitty','black','blade','blame','bland','blank','blare','blast','blaze','bleak','blear','bleat','bleed','blend','bless','blimp','blind','blink','blitz','bloat','block','bloke','blood','bloom','blown','blowy','blued','bluer','blues','bluff','blunt','blurb','blurt','blush','board','boast','bobby','bocce','bogey','boggy','bogie','boned','boner','bongo','booby','booed','boost','booth','booty','booze','boozy','borax','bored','borer','borne','boron','bosom','boson','bossy','botch','bough','bound','bowed','bowel','bower','bowie','boxed','boxer','brace','braid','brain','brake','brand','brant','brash','brass','brave','bravo','brawl','brawn','braze','bread','break','bream','breed','breve','briar','bribe','brick','bride','brief','brine','bring','brink','briny','brisk','broad','broil','broke','brood','brook','broom','broth','brown','bruin','brung','brunt','brush','brute','buddy','budge','buggy','bugle','build','built','bulge','bulky','bully','bumpy','bunch','bunko','bunny','burly','burnt','burro','burry','burst','bused','bushy','busty','butch','butte','buxom','buyer','buzzy','bylaw','byway','cabal','cabby','cabin','cable','cache','cacti','caddy','cadet','caged','cager','cagey','caked','camel','cameo','campy','canal','candy','canoe','canon','caped','caper','carat','cared','carer','caret','cargo','carne','carol','carom','carry','carve','cased','catch','caulk','cause','caved','cease','cedar','cello','chafe','chain','chair','chalk','champ','chant','charm','chart','chase','chasm','cheap','cheat','check','cheek','cheer','chess','chest','chewy','chick','chide','chief','child','chile','chili','chill','chime','chimp','china','chink','chirp','chive','choir','choke','chomp','chord','chore','chose','chuck','chump','chunk','churl','churn','chute','cider','cigar','cinch','circa','cited','civic','civil','clack','claim','clamp','clang','clank','clash','clasp','class','clean','clear','cleat','cleft','clerk','click','cliff','climb','cling','clink','cloak','clock','clone','close','cloth','cloud','clout','clove','clown','cluck','clued','clump','clung','clunk','coach','coast','cobra','cocky','cocoa','coded','coder','colon','color','combo','comet','comfy','comic','comma','conch','condo','coned','conic','cooed','cooky','coped','coral','cored','corer','corny','coset','costa','cotta','couch','cough','could','count','coupe','court','cover','covet','cower','crack','craft','cramp','crane','crank','crash','crass','crate','crave','crawl','craze','crazy','cream','creed','creek','creep','creme','crepe','crept','crest','cried','crier','crime','crimp','crisp','croak','crock','croft','crony','crook','cross','crowd','crown','crude','cruel','crumb','crush','crust','crypt','cubby','cubed','cubic','cupid','cuppy','cured','curly','curry','curse','curve','curvy','cushy','cuter','cycle','cynic','daddy','daily','dairy','daisy','dance','dandy','dared','darer','darky','dashy','dated','daunt','dazed','dealt','deary','death','debug','decaf','decal','decay','decor','decoy','decry','defer','deign','deity','delay','delta','delve','demon','denim','dense','depot','depth','derby','deter','deuce','devil','diary','diced','dicer','dicey','dicky','digit','dildo','dimly','dined','diner','dingo','dingy','diode','dirge','dirty','disco','ditch','ditto','divan','dived','diver','divot','dizzy','dodge','dodgy','doggy','dogma','doily','doing','dolly','domed','donor','donut','doped','dopey','dorky','dosed','doted','doubt','dough','douse','dowel','downy','dowry','dowse','dozed','dozen','dozer','draft','drain','drama','drank','drape','drawl','drawn','dread','dream','dress','dried','drier','drift','drill','drink','drive','droid','drone','drool','drove','drown','druid','drunk','dryer','ducky','dummy','dunce','duped','dusty','dutch','duvet','dwarf','dwell','dying','eager','eagle','early','earth','eased','easel','eaten','ebony','edged','edger','edict','eerie','egret','eight','eject','elate','elbow','elder','elect','elfin','elite','elope','elude','email','embed','emcee','emery','emote','empty','enact','endow','enema','enemy','enjoy','ensue','enter','entry','envoy','epoch','epoxy','epsom','equal','equip','erase','erect','erode','erred','error','erupt','essay','ether','ethic','etude','evade','event','every','evict','evoke','exact','exalt','excel','exert','exile','exist','expat','expel','extra','exude','fable','faced','facet','faded','faint','fairy','faith','faked','faker','famed','fancy','fanny','farce','fared','fatal','fated','fatly','fault','fauna','favor','faxed','fazed','feast','fecal','feign','feist','felon','femme','femur','fence','feral','ferry','fetal','fetch','fetid','fever','fewer','fiber','field','fiend','fiery','fifth','fifty','fight','filed','filer','filet','filly','filmy','filth','final','finch','fined','finer','fired','first','firth','fishy','fixed','fixer','fizzy','fjord','flack','flail','flair','flake','flaky','flame','flank','flare','flash','flask','fleck','fleet','flesh','flick','flied','flier','flies','fling','flint','flirt','float','flock','flood','floor','flora','floss','flour','flown','fluff','fluid','fluke','fluky','flume','flung','flunk','flush','flute','flyer','foamy','focal','foggy','folio','folky','folly','fondu','foray','force','forge','forgo','forte','forth','forty','forum','found','fount','foxed','foyer','frail','frame','frank','fraud','freak','freed','freer','fresh','friar','fried','frier','frill','frisk','frizz','frock','front','frost','froth','frown','froze','fruit','frump','fryer','fudge','fudgy','fugue','fully','fumed','fungi','funky','funny','furor','furry','fused','fussy','futon','fuzed','fuzzy','gabby','gable','gaffe','gamed','gamer','gamma','gamut','gaped','gaper','gassy','gated','gator','gaudy','gauge','gaunt','gauze','gavel','gawky','gazed','gazer','gecko','geese','genie','genre','geode','ghost','ghoul','giant','giddy','gimpy','girly','girth','given','giver','gizmo','glade','gland','glare','glary','glass','glaze','gleam','glean','glide','glint','glitz','gloat','globe','gloom','glory','gloss','glove','glued','gluer','gnarl','gnash','gnome','godly','gofer','going','golly','gonad','goner','gonna','gonzo','goody','gooey','goofy','gooky','goopy','goose','gored','gorge','gouda','gouge','gourd','grace','grade','graft','grail','grain','grand','grant','grape','graph','grasp','grass','grate','grave','gravy','graze','great','greed','greek','green','greet','grief','grift','grill','grime','grimy','grind','gripe','groan','groin','groom','grope','gross','group','grout','grove','growl','grown','gruel','gruff','grump','grunt','guard','guava','guess','guest','guide','guild','guile','guilt','guise','gulag','gulch','gumbo','gummy','guppy','gushy','gusto','gusty','gutsy','gypsy','habit','haiku','hairy','haled','halve','handy','hanky','happy','harem','harsh','harum','haste','hasty','hatch','hated','hater','haunt','haven','havoc','hazed','hazel','heard','heart','heath','heave','heavy','hedge','hefty','heist','helix','hello','hence','henna','heron','hertz','hexed','hider','hiked','hiker','hilly','hinge','hippo','hippy','hired','hirer','hitch','hoagy','hoard','hobby','hoist','hokey','holed','holer','holey','holly','homed','homer','homey','honed','honey','honor','hooch','hooky','hoped','hoppy','horny','horse','hosed','hotel','hotly','hound','house','hover','howdy','hubby','huger','hulky','human','humid','humor','humpy','humus','hunch','hunky','hurry','husky','hutch','hydra','hydro','hyena','hyped','hyper','icier','icing','ideal','idiom','idiot','idled','idyll','igloo','image','imply','inane','inapt','incur','index','indie','inept','inert','infer','injun','inked','inlay','inlet','inner','input','inset','inter','intro','ionic','irate','irked','irony','islet','issue','itchy','ivory','jaded','jammy','japan','jaunt','jawed','jazzy','jello','jelly','jerky','jetty','jewel','jiffy','jihad','jived','joint','joist','joked','joker','jolly','joule','joust','joyed','judge','juice','juicy','jumbo','jumpy','junky','juror','kabob','kappa','karma','kayak','kazoo','kebab','keyed','khaki','kicky','kiddo','kinda','kinky','kiosk','kitty','klunk','klutz','knack','knead','kneed','kneel','knelt','knife','knock','known','koala','kooky','kraut','krill','kudzu','label','labia','labor','laced','laden','ladle','lager','laity','lanai','lance','lanky','lapel','lapse','large','largo','larva','laser','lasso','latch','later','latex','lathe','latin','laugh','layer','layup','lazed','leach','leafy','leaky','leapt','learn','lease','leash','least','leave','ledge','leech','leery','lefty','legal','leggy','legit','lemon','lemur','leper','letup','levee','level','lever','libel','libra','light','liked','liken','lilac','limbo','limey','limit','lined','linen','liner','lingo','lipid','liter','lived','liven','liver','livid','llama','loath','lobby','lobed','local','lodge','lofty','loggy','logic','login','loner','loopy','loose','loped','lorry','loser','lotto','louse','lousy','loved','lover','lower','lowly','loyal','lucid','lucky','lumen','lumpy','lunar','lunch','lunge','lurch','lured','lusty','lycra','lying','lymph','lynch','lyric','macaw','maced','macho','macro','madam','madly','mafia','magic','magma','magna','maize','major','maker','mambo','maned','mange','mango','mangy','mania','manic','manly','manor','manta','maple','march','marry','marsh','mason','masse','match','mated','matey','matte','matzo','mauve','maven','maxim','maybe','mayor','mazed','meant','meaty','mecca','medal','media','medic','melee','melon','mercy','merge','merit','merry','messy','metal','meter','metro','micro','midst','might','miked','milch','milky','mimic','mince','mined','miner','minor','mired','miser','missy','misty','miter','mixed','mixer','mixup','mocha','modal','model','modem','mogul','moist','molar','moldy','momma','mommy','money','month','mooch','moody','moose','moped','moral','moron','morph','mossy','motel','motif','motor','motto','mould','mound','mount','mourn','mouse','mouth','moved','mover','movie','mowed','mower','moxie','mucky','muddy','muggy','mulch','mumbo','mummy','munch','mural','murky','mused','mushy','music','musty','muted','muter','mylar','nacho','naive','naked','named','nanny','nappy','narco','nasal','nasty','natal','natch','naval','navel','needy','negro','nerdy','nerve','nervy','never','newer','newly','nicer','niche','niece','nifty','night','ninja','ninth','nippy','nisei','niter','nitro','nixed','noble','nobly','nodal','noise','noisy','nomad','noose','north','nosed','nosey','notch','noted','novel','nudge','nudie','nuked','nurse','nutty','nylon','nymph','oaken','obese','occur','ocean','ocher','ochre','octal','octet','odder','oddly','offer','often','ogled','oiled','oinky','okapi','olden','older','oldie','olive','omega','onion','onset','oodle','oomph','oozed','opera','opine','opium','opted','optic','orate','orbit','order','organ','ortho','other','otter','ought','ounce','outdo','outer','outie','ovary','ovate','overt','owing','owned','owner','oxbow','oxide','ozone','paced','pacer','paddy','padre','pagan','paged','pager','paint','paled','paler','palsy','panda','paned','panel','panic','pansy','panty','papal','paper','parch','pared','parka','parse','party','passe','pasta','paste','pasty','patch','patio','patsy','patty','pause','paved','paver','pawed','payed','payee','payer','peace','peach','peaky','pearl','pecan','pedal','peeve','penal','penny','peony','peppy','perch','peril','perky','pesky','pesto','petal','petri','petty','phase','phone','phony','photo','piano','picky','piece','piety','piggy','pilaf','piled','pilot','pinch','pined','piney','pinky','pinto','pinup','piped','piper','pique','pitch','pivot','pixel','pixie','pizza','place','plaid','plain','plane','plank','plant','plate','plaza','plead','pleat','plebe','plied','pluck','plumb','plume','plump','plunk','plush','poach','point','poise','poked','poker','pokey','polar','poled','polio','polka','polyp','pooch','poppy','porch','porky','porno','posed','posse','potty','pouch','pound','power','prank','prawn','press','price','prick','pride','prime','primo','primp','print','prior','prism','privy','prize','probe','promo','prone','prong','proof','prose','proud','prove','prowl','proxy','prude','prune','psalm','psych','pubic','pudgy','puffy','puked','pulse','punch','punky','pupil','puppy','puree','purer','purge','purse','pushy','pussy','putty','pygmy','pylon','quack','quail','quake','qualm','quark','quart','quash','quasi','queen','queer','quell','query','quest','queue','quick','quiet','quill','quilt','quint','quirk','quirt','quite','quota','quote','rabbi','rabid','raced','racer','radar','radii','radio','raged','rainy','raise','raked','rally','ranch','randy','range','rangy','raped','rapid','rarer','raspy','rated','rater','ratio','ratty','raved','raven','raver','rayon','razed','razor','reach','react','ready','realm','rebel','recap','recur','refer','refit','regal','rehab','reign','relax','relay','relic','remit','remix','renal','renew','repay','repel','reply','rerun','reset','resin','retro','retry','reuse','revel','revue','rhino','rhyme','riced','rider','ridge','ridgy','rifle','right','rigid','rigor','riled','rinse','ripen','risen','riser','risky','ritzy','rival','river','rivet','roach','roast','robed','robin','robot','rocky','rodeo','rogue','roman','roomy','roost','roped','rosin','rotor','rouge','rough','round','rouse','route','roved','rover','rowdy','rowed','rower','royal','ruder','rugby','ruled','ruler','rumba','rummy','rumor','runny','rural','rusty','saber','sable','sadly','safer','saint','salad','sally','salon','salsa','salty','salvo','samba','sandy','saner','sappy','sassy','sated','satin','sauce','saucy','sauna','saute','saved','saver','savor','savvy','sawed','sayer','scald','scale','scalp','scaly','scamp','scant','scare','scarf','scary','scene','scent','scion','scoff','scold','scone','scoop','scoot','scope','score','scorn','scour','scout','scowl','scram','scrap','screw','scrub','scrum','scuba','scuff','seamy','sedan','seedy','segue','seize','sense','septa','serif','serum','serve','servo','setup','seven','sever','sewed','sewer','shack','shade','shady','shaft','shake','shaky','shale','shame','shank','shape','shard','share','shark','sharp','shave','shawl','shear','sheen','sheep','sheer','sheet','sheik','shelf','shell','shied','shift','shill','shine','shiny','shire','shirt','shoal','shock','shoed','shone','shook','shoot','shore','shorn','short','shout','shove','shown','showy','shred','shrew','shrub','shrug','shuck','shunt','shush','sided','siege','sieve','sight','sigma','silky','silly','silty','since','singe','sired','siren','sissy','sitar','sited','sixth','sixty','sized','sizer','skate','skeet','skied','skier','skies','skiff','skill','skimp','skirt','skull','skunk','slack','slain','slang','slant','slash','slate','slave','sleek','sleep','sleet','slept','slice','slick','slide','slime','slimy','sling','sloop','slope','slosh','sloth','slump','slung','slurp','slush','smack','small','smart','smash','smear','smell','smelt','smile','smirk','smith','smock','smoke','smoky','smurf','snack','snafu','snail','snake','snaky','snare','snarf','snark','snarl','sneak','sneer','snide','sniff','snipe','snoop','snoot','snore','snort','snout','snowy','snuck','snuff','soapy','sober','soggy','solar','solid','solve','sonar','sonic','sooth','soppy','sorer','sorry','sound','soupy','south','sowed','sower','space','spacy','spade','spake','spank','spare','spark','spasm','spate','spawn','speak','spear','speck','speed','spell','spend','spent','sperm','spice','spicy','spied','spiel','spies','spiff','spike','spiky','spill','spilt','spine','spiny','spire','spite','splat','splay','split','spoil','spoke','spoof','spook','spool','spoon','spore','sport','spout','sprat','spray','spree','sprig','sprit','spunk','spurn','spurt','squad','squat','squaw','squib','squid','stack','staff','stage','stain','stair','stake','stale','stalk','stall','stamp','stand','stank','staph','stare','stark','start','stash','stave','stead','steak','steal','steam','steel','steep','steer','stein','stern','stick','stiff','stile','still','stilt','sting','stink','stint','stock','stoic','stoke','stole','stomp','stone','stony','stood','stool','stoop','store','stork','storm','story','stout','stove','strap','straw','stray','strep','strew','strip','strum','strut','stuck','study','stuff','stump','stung','stunk','stunt','style','suave','sudsy','suede','sugar','suing','suite','sulky','sunny','sunup','super','surer','surge','surly','sushi','swain','swami','swamp','swank','swarm','swash','swath','swear','sweat','swede','sweep','sweet','swell','swept','swift','swine','swing','swipe','swirl','swish','swiss','swoon','swoop','sword','swore','sworn','swung','syrup','tabby','table','taboo','tacet','tacit','tacky','taffy','taint','taken','taker','tally','talon','tamed','tamer','tango','taped','taper','tapir','tardy','tarot','tarry','taste','tasty','tater','taunt','taupe','tawny','taxed','taxer','teach','teary','tease','techy','teddy','teeny','teeth','tempo','tempt','tenet','tenor','tense','tenth','tepee','tepid','terra','terse','tesla','testy','thank','thanx','theft','their','theme','there','therm','these','theta','thick','thief','thigh','thine','thing','think','third','thong','thorn','those','three','threw','throb','throe','throw','thrum','thumb','thump','thunk','thyme','tiara','tibia','tidal','tided','tiger','tight','tilde','tiled','tiler','timed','timer','timid','tinny','tippy','tipsy','tired','titan','title','titty','tizzy','toady','toast','today','toddy','toffy','token','tonal','toned','toner','tonic','tooth','topaz','topic','torah','torch','torso','torte','total','toted','totem','touch','tough','towed','towel','tower','toxic','toxin','toyed','toyer','trace','track','tract','trade','trail','train','trait','tramp','trash','trawl','tread','treat','trend','triad','trial','tribe','trick','tried','trier','trike','trill','tripe','trite','troll','tromp','troop','trout','trove','truce','truck','truer','truly','trump','trunk','truss','trust','truth','tryst','tubal','tubby','tubed','tuber','tulip','tummy','tumor','tuned','tuner','tunic','turbo','tutor','twang','tweak','tweed','tweet','twerp','twice','twill','twirl','twist','tying','typed','udder','ulcer','ulnar','ultra','umber','unarm','unbox','uncap','uncle','uncut','under','undid','unfit','unify','union','unite','unity','unsee','unset','untie','until','unzip','upend','upped','upper','upset','urban','urged','urger','urine','usage','usher','using','usual','usurp','utero','utter','uvula','vague','valet','valid','valor','value','valve','vaned','vapor','vault','vaunt','vegan','veiny','venal','venom','venue','verge','versa','verse','verve','vexed','vicar','video','vigil','vigor','villa','vinyl','viola','viper','viral','visit','visor','vista','vital','vitro','vivid','vixen','vizor','vocab','vocal','vodka','vogue','voice','voila','vomit','voted','voter','vouch','vowed','vowel','vroom','vulva','vying','wacko','wacky','waded','wader','wafer','waged','wager','wagon','waist','waive','waked','waken','waker','waled','waltz','waned','warty','washy','waste','watch','water','waved','waver','waxed','waxen','waxer','weary','weave','weber','wedge','wedgy','weedy','weepy','weigh','weird','welsh','wench','wetly','whack','whale','wharf','wheat','wheel','whelm','whelp','where','which','whiff','while','whine','whiny','whirl','whish','whisk','white','whole','whomp','whoop','whore','whose','widen','wider','widow','width','wield','wifey','wimpy','wince','winch','windy','wined','winey','wiped','wiper','wired','wirer','wised','wiser','witch','witty','woken','woman','women','wonky','woody','wooed','wooer','wooly','woosh','woozy','wordy','world','wormy','worry','worse','worst','worth','would','wound','woven','wowed','wrath','wreak','wreck','wring','wrist','write','wrong','wrote','wroth','wryly','wurst','xenon','xerox','yacht','yahoo','yawny','yearn','yeast','yield','yodel','yoked','yolky','young','yourn','youth','yucca','yucky','yummy','zebra','zesty','zilch','zingy','zippy','zoned'];
const WORD_LENGTH=5;
const MAX_GUESSES=6;
let targetWord="";
let currentGuess="";
let currentRow=0;
let gameOver=false;
let board=[];
let letterStates={};
let activeGame=null;
let guessHistory=[];
let isSyncInProgress=false;
let syncRetryMs=2000;
const MAX_SYNC_RETRY_MS=60000;

const STORAGE_KEYS={
  deviceId:"wordle_device_id",
  pendingQueue:"wordle_pending_queue"
};
function generateClientId(){
  if(window.crypto&&window.crypto.randomUUID){
    return window.crypto.randomUUID();
  }
  return `id_${Date.now()}_${Math.random().toString(36).slice(2,10)}`;
}

function getDeviceId(){
  try{
    const existing=localStorage.getItem(STORAGE_KEYS.deviceId);
    if(existing)return existing;
    const created=generateClientId();
    localStorage.setItem(STORAGE_KEYS.deviceId,created);
    return created;
  }catch(e){
    return "browser_device_unavailable";
  }
}

function getPendingQueue(){
  try{
    const raw=localStorage.getItem(STORAGE_KEYS.pendingQueue);
    if(!raw)return [];
    const parsed=JSON.parse(raw);
    return Array.isArray(parsed)?parsed:[];
  }catch(e){
    return [];
  }
}

function setPendingQueue(queue){
  try{
    localStorage.setItem(STORAGE_KEYS.pendingQueue,JSON.stringify(queue));
  }catch(e){
    // Ignore storage errors and keep game playable.
  }
}

function enqueueCompletedGame(game){
  const queue=getPendingQueue();
  queue.push(game);
  setPendingQueue(queue);
}

function removeAcknowledgedGames(ackedIds){
  if(!ackedIds.length)return;
  const ackSet=new Set(ackedIds);
  const queue=getPendingQueue();
  const filtered=queue.filter(game=>!ackSet.has(game.client_game_id));
  setPendingQueue(filtered);
}

function localISOString(date){
  const p=n=>String(n).padStart(2,"0");
  return `${date.getFullYear()}-${p(date.getMonth()+1)}-${p(date.getDate())}T${p(date.getHours())}:${p(date.getMinutes())}:${p(date.getSeconds())}`;
}

function getUsername(){
  return localStorage.getItem("wordle_username")||"";
}

function getDifficulty(){
  return localStorage.getItem("wordle_difficulty")||"normal";
}

function createGameSession(){
  activeGame={
    client_game_id:generateClientId(),
    device_id:getDeviceId(),
    username:getUsername()||null,
    difficulty:getDifficulty(),
    start_time:localISOString(new Date()),
    end_time:null,
    target_word:targetWord.toLowerCase(),
    outcome:null,
    guesses:[],
    remaining_counts:[]
  };
}

function recordGuess(guess){
  if(!activeGame)return;
  activeGame.guesses.push(guess.toLowerCase());
}

function finalizeGame(outcome){
  if(!activeGame||activeGame.outcome)return;
  activeGame.outcome=outcome;
  activeGame.end_time=localISOString(new Date());
  activeGame.guesses_count=activeGame.guesses.length;
  enqueueCompletedGame(activeGame);
  activeGame=null;
  trySyncPendingGames();
}

function scheduleSyncRetry(){
  setTimeout(()=>{
    trySyncPendingGames();
  },syncRetryMs);
  syncRetryMs=Math.min(syncRetryMs*2,MAX_SYNC_RETRY_MS);
}

async function trySyncPendingGames(){
  if(isSyncInProgress)return;
  if(!navigator.onLine)return;

  const pendingGames=getPendingQueue();
  if(!pendingGames.length)return;

  isSyncInProgress=true;
  try{
    const response=await fetch("/api/wordle-sync",{
      method:"POST",
      headers:{
        "Content-Type":"application/json"
      },
      body:JSON.stringify({games:pendingGames})
    });

    if(!response.ok){
      throw new Error(`Sync failed with status ${response.status}`);
    }

    const payload=await response.json();
    const ackedIds=Array.isArray(payload.acked_ids)?payload.acked_ids:[];
    removeAcknowledgedGames(ackedIds);
    syncRetryMs=2000;
  }catch(error){
    scheduleSyncRetry();
  }finally{
    isSyncInProgress=false;
  }
}

function initGame(opts){
  const specificWord=opts&&opts.word;
  const isMultiplayer=!!(opts&&opts.multiplayer);
  targetWord=specificWord||WORDS[Math.floor(Math.random()*WORDS.length)];
  currentGuess="";
  currentRow=0;
  gameOver=false;
  board=[];
  letterStates={};
  guessHistory=[];
  document.getElementById("message").textContent="";
  document.getElementById("new-game-btn").style.display="none";
  const boardEl=document.getElementById("board");
  boardEl.innerHTML="";
  for(let i=0;i<MAX_GUESSES;i++){
    const row=[];
    for(let j=0;j<WORD_LENGTH;j++){
      const tile=document.createElement("div");
      tile.className="tile";
      boardEl.appendChild(tile);
      row.push(tile);
    }
    board.push(row);
  }
  updateKeyboard();
  if(isMultiplayer){
    activeGame=null;
    mpWinReported=false;
    clearTimeout(mpGameTimer);
    mpGameTimer=setTimeout(mpTimeout,MP_TIMEOUT_MS);
  }else{
    createGameSession();
  }
  applyDifficultyUI();
}

function updateKeyboard(){
  const keys=document.querySelectorAll(".keyboard-key[data-key]");
  keys.forEach(key=>{
    const letter=key.dataset.key;
    if(letter==="ENTER"||letter==="BACKSPACE")return;
    const isWide=key.classList.contains("wide");
    const isExtraWide=key.classList.contains("extra-wide");
    key.className="keyboard-key";
    if(isWide)key.classList.add("wide");
    if(isExtraWide)key.classList.add("extra-wide");
    if(letterStates[letter]){
      key.classList.add(letterStates[letter]);
    }
  });
}

function updateBoard(){
  const row=board[currentRow];
  for(let i=0;i<WORD_LENGTH;i++){
    row[i].textContent=currentGuess[i]||"";
    row[i].classList.toggle("filled",!!currentGuess[i]);
  }
}

function getTileState(guess,target){
  const states=Array(WORD_LENGTH).fill("absent");
  const targetCounts={};
  const guessCounts={};
  for(let i=0;i<WORD_LENGTH;i++){
    if(guess[i]===target[i])states[i]="correct";
    targetCounts[target[i]]=(targetCounts[target[i]]||0)+1;
  }
  for(let i=0;i<WORD_LENGTH;i++){
    if(states[i]==="correct"){
      guessCounts[guess[i]]=(guessCounts[guess[i]]||0)+1;
    }
  }
  for(let i=0;i<WORD_LENGTH;i++){
    if(states[i]!=="correct"){
      const letter=guess[i];
      const targetCount=targetCounts[letter]||0;
      const guessCount=guessCounts[letter]||0;
      if(target.includes(letter)&&guessCount<targetCount){
        states[i]="present";
        guessCounts[letter]=(guessCounts[letter]||0)+1;
      }
    }
  }
  return states;
}

function updateLetterStates(guess,states){
  for(let i=0;i<WORD_LENGTH;i++){
    const letter=guess[i].toUpperCase();
    const state=states[i];
    if(!letterStates[letter]||state==="correct"||(state==="present"&&letterStates[letter]!=="correct")){
      letterStates[letter]=state;
    }
  }
  updateKeyboard();
}

function submitGuess(){
  if(currentGuess.length!==WORD_LENGTH)return;
  if(!WORDS.includes(currentGuess.toLowerCase())){
    showMessage("Not in word list");
    return;
  }
  const hardErr=checkHardModeConstraints(currentGuess);
  if(hardErr){
    showMessage(hardErr);
    return;
  }
  recordGuess(currentGuess.toLowerCase());
  const row=board[currentRow];
  const states=getTileState(currentGuess.toLowerCase(),targetWord);
  updateLetterStates(currentGuess,states);
  guessHistory.push({guess:currentGuess.toLowerCase(),states});
  updateRemainingCount();
  if(activeGame) activeGame.remaining_counts.push(getRemainingWords().length);
  for(let i=0;i<WORD_LENGTH;i++){
    setTimeout(()=>{
      row[i].classList.add("flip");
      row[i].classList.remove("filled");
      row[i].classList.add(states[i]);
      setTimeout(()=>row[i].classList.remove("flip"),500);
    },i*100);
  }
  if(currentGuess.toLowerCase()===targetWord){
    gameOver=true;
    finalizeGame("win");
    if(mpRoomId){
      mpReportWin(currentRow+1);
    }
    setTimeout(()=>{
      showMessage("You won!",0);
      if(!mpRoomId) document.getElementById("new-game-btn").style.display="block";
    },600);
  }else if(currentRow===MAX_GUESSES-1){
    gameOver=true;
    finalizeGame("loss");
    setTimeout(()=>{
      showMessage(`You lost! The word was ${targetWord.toUpperCase()}`,0);
      if(!mpRoomId) document.getElementById("new-game-btn").style.display="block";
    },600);
  }else{
    currentRow++;
    currentGuess="";
  }
}

function handleKeyInput(key){
  if(gameOver){
    // Don't start a solo game while a multiplayer game is active.
    if(key==="ENTER"&&!mpRoomId) initGame();
    return;
  }
  if(key==="BACKSPACE"){
    if(currentGuess.length>0){
      currentGuess=currentGuess.slice(0,-1);
      updateBoard();
    }
  }else if(key==="ENTER"){
    if(currentGuess.length===WORD_LENGTH){
      submitGuess();
    }
  }else if(key.length===1&&key>="A"&&key<="Z"&&currentGuess.length<WORD_LENGTH){
    currentGuess+=key;
    updateBoard();
  }
}

document.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"||e.key==="Backspace"){
    if(e.key==="Enter"){
      handleKeyInput("ENTER");
    }else if(e.key==="Backspace"){
      handleKeyInput("BACKSPACE");
    }
  }else if(e.key.length===1&&e.key>="a"&&e.key<="z"){
    handleKeyInput(e.key.toUpperCase());
  }
});

document.querySelectorAll(".keyboard-key").forEach(key=>{
  key.addEventListener("click",()=>{
    const keyValue=key.dataset.key;
    if(keyValue==="BACKSPACE"){
      handleKeyInput("BACKSPACE");
    }else if(keyValue==="ENTER"){
      handleKeyInput("ENTER");
    }else{
      handleKeyInput(keyValue);
    }
  });
});

document.getElementById("new-game-btn").addEventListener("click",initGame);
window.addEventListener("online",()=>{
  syncRetryMs=2000;
  trySyncPendingGames();
});

// ── Remaining words ────────────────────────────────────────────────────────

function getRemainingWords(){
  if(!guessHistory.length) return WORDS.slice();
  return WORDS.filter(word=>{
    for(const {guess,states} of guessHistory){
      // Build per-letter min-count (from greens+yellows) and absent flag
      const minCounts={}, hasAbsent={};
      for(let i=0;i<WORD_LENGTH;i++){
        const c=guess[i];
        if(states[i]==="correct"||states[i]==="present"){
          minCounts[c]=(minCounts[c]||0)+1;
        }else{
          hasAbsent[c]=true;
        }
      }
      // Check count constraints for every letter that appeared in the guess
      for(const c of new Set(guess)){
        const min=minCounts[c]||0;
        const cnt=word.split("").filter(l=>l===c).length;
        if(cnt<min) return false;
        if(hasAbsent[c]&&cnt>min) return false;
      }
      // Check position constraints
      for(let i=0;i<WORD_LENGTH;i++){
        if(states[i]==="correct"&&word[i]!==guess[i]) return false;
        if(states[i]==="present"&&word[i]===guess[i]) return false;
      }
    }
    return true;
  });
}

let _msgTimer=null;
function showMessage(text,duration=2000){
  const el=document.getElementById("message");
  el.textContent=text;
  clearTimeout(_msgTimer);
  if(duration>0) _msgTimer=setTimeout(()=>{el.textContent="";},duration);
}

function ordinal(n){
  const s=["th","st","nd","rd"];
  const v=n%100;
  return n+(s[(v-20)%10]||s[v]||s[0]);
}

function checkHardModeConstraints(guess){
  const difficulty=getDifficulty();
  if(difficulty==="easy"||difficulty==="normal"||!guessHistory.length) return null;
  const g=guess.toLowerCase();

  // Collect green (required position) and yellow (required letter + forbidden positions) constraints.
  const requiredPositions={};
  const requiredLetters={};
  for(const {guess:pg,states} of guessHistory){
    for(let i=0;i<states.length;i++){
      if(states[i]==="correct"){
        requiredPositions[i]=pg[i];
      }else if(states[i]==="present"){
        if(!requiredLetters[pg[i]]) requiredLetters[pg[i]]=new Set();
        requiredLetters[pg[i]].add(i);
      }
    }
  }

  // Green constraints (Hard + Super Hard): must reuse in same position.
  for(const [pos,letter] of Object.entries(requiredPositions)){
    if(g[Number(pos)]!==letter){
      return `${ordinal(Number(pos)+1)} letter must be ${letter.toUpperCase()}`;
    }
  }

  // Yellow constraints (Hard + Super Hard): letter must appear somewhere.
  // Super Hard adds: must NOT be placed in its previous yellow position(s).
  for(const [letter,forbiddenPositions] of Object.entries(requiredLetters)){
    if(!g.includes(letter)){
      return `Guess must contain ${letter.toUpperCase()}`;
    }
    if(difficulty==="superhard"){
      for(const pos of forbiddenPositions){
        if(g[pos]===letter){
          return `${letter.toUpperCase()} cannot be in position ${pos+1}`;
        }
      }
    }
  }

  // Gray constraints (Super Hard only): must not reuse eliminated letters.
  if(difficulty==="superhard"){
    for(const [letter,state] of Object.entries(letterStates)){
      if(state==="absent"&&g.includes(letter.toLowerCase())){
        return `Guess cannot contain ${letter.toUpperCase()}`;
      }
    }
  }

  return null;
}

function applyDifficultyUI(){
  const d=getDifficulty();
  const btn=document.getElementById("remaining-btn");
  if(d==="superhard"){
    btn.style.visibility="hidden";
  }else{
    btn.style.visibility="";
    updateRemainingCount();
  }
  // Tapping the count only opens the modal in Easy mode; update button style
  // to signal interactivity (cursor pointer vs default).
  btn.style.cursor=(d==="easy")?"pointer":"default";
}

function updateRemainingCount(){
  document.getElementById("remaining-btn").textContent=getRemainingWords().length;
}

function selectWord(word){
  if(gameOver) return;
  const err=checkHardModeConstraints(word);
  if(err){
    closeWordsModal();
    showMessage(err);
    return;
  }
  closeWordsModal();
  while(currentGuess.length>0) handleKeyInput("BACKSPACE");
  for(const ch of word.toUpperCase()) handleKeyInput(ch);
}

function openWordsModal(){
  const words=getRemainingWords().slice().sort();
  const grid=document.getElementById("words-grid");
  const title=document.getElementById("words-card-title");
  title.textContent=`${words.length} Possible Word${words.length!==1?"s":""}`;
  grid.innerHTML="";
  words.forEach(w=>{
    const el=document.createElement("div");
    el.className="wword";
    el.textContent=w;
    // Distinguish a tap from a scroll: reject if pointer moved more than 6px.
    let pX=0,pY=0;
    el.addEventListener("pointerdown",e=>{pX=e.clientX;pY=e.clientY;},{passive:true});
    el.addEventListener("pointerup",e=>{
      if(Math.hypot(e.clientX-pX,e.clientY-pY)<6) selectWord(w);
    },{passive:true});
    grid.appendChild(el);
  });
  document.getElementById("words-modal").classList.add("open");
}

function closeWordsModal(){
  document.getElementById("words-modal").classList.remove("open");
}

document.getElementById("remaining-btn").addEventListener("click",()=>{
  const d=getDifficulty();
  if(d!=="easy"){
    showMessage("Word list only available in Easy mode",2000);
    return;
  }
  openWordsModal();
});
document.getElementById("words-close").addEventListener("click",closeWordsModal);
document.getElementById("words-backdrop").addEventListener("click",closeWordsModal);

// ── Statistics page ────────────────────────────────────────────────────────

function renderStatsCol(elId, data, label){
  const col=document.getElementById(elId);
  col.innerHTML="";

  const title=document.createElement("div");
  title.className="scol-title";
  title.textContent=label;
  col.appendChild(title);

  const summary=document.createElement("div");
  summary.className="scol-summary";
  const shtml=`<b>${data.totalGames}</b> ${data.totalGames===1?"Game":"Games"}<br><b>${data.winPct}%</b> Win Rate<br><b>${data.currentStreak}</b> Streak&nbsp;·&nbsp;<b>${data.bestStreak}</b> Best`;
  summary.innerHTML=shtml;
  col.appendChild(summary);

  const distLbl=document.createElement("div");
  distLbl.className="ssec";
  distLbl.textContent="Guess Distribution";
  col.appendChild(distLbl);

  const keys=["1","2","3","4","5","6","loss"];
  const vals=keys.map(k=>data.distribution[k]||0);
  const maxVal=Math.max(...vals,1);
  keys.forEach((key,i)=>{
    const cnt=vals[i];
    const pct=data.totalGames>0?Math.round(cnt/data.totalGames*100):0;
    const bw=Math.round(cnt/maxVal*100);
    const lbl=key==="loss"?"✗":key;
    const row=document.createElement("div");
    row.className="drow";
    row.innerHTML=`<span class="dlbl">${lbl}</span><div class="dbar-bg"><div class="dbar${key==="loss"?" loss":""}" style="width:${bw}%"></div></div><span class="dpct">${pct}%</span>`;
    col.appendChild(row);
  });

  if(data.topStarters&&data.topStarters.length){
    const startLbl=document.createElement("div");
    startLbl.className="ssec";
    startLbl.textContent="Top Starters";
    col.appendChild(startLbl);
    const maxSt=Math.max(...data.topStarters.map(s=>s.count),1);
    data.topStarters.forEach(s=>{
      const bw=Math.round(s.count/maxSt*100);
      const row=document.createElement("div");
      row.className="srow";
      row.innerHTML=`<span class="sword">${s.word}</span><div class="sbar-bg"><div class="sbar" style="width:${bw}%"></div></div><span class="spct">${s.pct}%</span>`;
      col.appendChild(row);
    });
  }
}

function renderFirstWords(elId, words){
  const el=document.getElementById(elId);
  el.innerHTML="";
  if(!words||!words.length){
    const d=document.createElement("div");
    d.className="fwno-data";
    d.textContent="Need 3+ games per word";
    el.appendChild(d);
    return;
  }
  words.forEach(w=>{
    const row=document.createElement("div");
    row.className="fwrow";
    row.innerHTML=`<span class="fwword">${w.word}</span><span class="fwavg">${Math.round(w.avgRemaining)}</span>`;
    el.appendChild(row);
  });
}

function renderExtraStats(me, overall){
  // Possibilities Per Guess table
  const ppgBody=document.getElementById("ppg-body");
  ppgBody.innerHTML="";
  const mePpgMap=Object.fromEntries((me.possibilitiesPerGuess||[]).map(p=>[p.guessNum,p.avgRemaining]));
  const ovPpgMap=Object.fromEntries((overall.possibilitiesPerGuess||[]).map(p=>[p.guessNum,p.avgRemaining]));
  const allNums=new Set([...Object.keys(mePpgMap),...Object.keys(ovPpgMap)].map(Number));
  [...allNums].sort((a,b)=>a-b).forEach(g=>{
    const meVal=mePpgMap[g];
    const ovVal=ovPpgMap[g];
    let meClass="ppg-me";
    if(meVal!==undefined&&ovVal!==undefined){
      if(meVal<ovVal) meClass="ppg-better";
      else if(meVal>ovVal) meClass="ppg-worse";
    }
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${g}</td><td class="${meClass}">${meVal!==undefined?Math.round(meVal):"—"}</td><td>${ovVal!==undefined?Math.round(ovVal):"—"}</td>`;
    ppgBody.appendChild(tr);
  });

  // Best / Worst First Words
  renderFirstWords("fw-best-me",me.bestFirstWords);
  renderFirstWords("fw-best-overall",overall.bestFirstWords);
  renderFirstWords("fw-worst-me",me.worstFirstWords);
  renderFirstWords("fw-worst-overall",overall.worstFirstWords);

  document.getElementById("stats-extra").style.display="";
}

async function loadStats(){
  const msg=document.getElementById("stats-msg");
  const cols=document.getElementById("stats-cols");
  const extra=document.getElementById("stats-extra");
  msg.textContent="Loading...";
  msg.style.color="#9ca3af";
  msg.style.display="block";
  cols.style.display="none";
  extra.style.display="none";
  try{
    const username=getUsername();
    const r=await fetch(`/api/wordle-stats?username=${encodeURIComponent(username)}`);
    if(!r.ok) throw new Error("HTTP "+r.status);
    const d=await r.json();
    const meLabel=username?username.toUpperCase():"ME";
    renderStatsCol("col-me",d.me,meLabel);
    renderStatsCol("col-overall",d.overall,"OVERALL");
    renderExtraStats(d.me,d.overall);
    msg.style.display="none";
    cols.style.display="";
  }catch(e){
    msg.textContent="Could not load statistics. Check your connection.";
    msg.style.color="#f87171";
  }
}

/* ── Difficulty control ───────────────────────────────────── */
const DIFF_DESCS={
  easy:"No restrictions — word list & count always available",
  normal:"No restrictions — word list hidden, count shown",
  hard:"Must use revealed green & yellow letters",
  superhard:"Hard Mode + avoid gray letters & fix yellow positions"
};

function updateDifficultyButtons(){
  const d=getDifficulty();
  document.querySelectorAll(".diff-btn").forEach(btn=>{
    btn.classList.toggle("active",btn.dataset.value===d);
  });
  document.getElementById("diff-desc").textContent=DIFF_DESCS[d]||"";
}

document.getElementById("diff-btns").addEventListener("click",e=>{
  const btn=e.target.closest(".diff-btn");
  if(!btn) return;
  const value=btn.dataset.value;
  localStorage.setItem("wordle_difficulty",value);
  updateDifficultyButtons();
  applyDifficultyUI();
  // If no guesses have been made yet, update the current game session so
  // the DB records the difficulty that was actually in effect when guessing began.
  if(activeGame&&guessHistory.length===0) activeGame.difficulty=value;
});

/* ── Username modal ───────────────────────────────────────── */
function updateGearBtn(){
  const btn=document.getElementById("gear-btn");
  const locked=!!mpRoomId;
  btn.classList.toggle("mp-locked",locked);
  btn.title=locked?"Settings locked during multiplayer game":"";
}

async function openUserModal(){
  // Silently block settings during an active multiplayer game.
  if(mpRoomId) return;
  const input=document.getElementById("user-input");
  const warning=document.getElementById("user-warning");
  const chips=document.getElementById("user-chips");
  const current=getUsername();
  input.value=current.toUpperCase();
  warning.textContent="";
  chips.innerHTML="";
  updateDifficultyButtons();
  populateThemePickers();
  document.getElementById("user-modal").classList.add("open");
  // Only auto-focus the text input for first-time users (no username yet).
  // For returning users, focus Save so the mobile keyboard doesn't auto-open.
  if(current){
    document.getElementById("user-save").focus();
  }else{
    input.focus();
  }

  // Fetch existing users and render chips.
  try{
    const r=await fetch("/api/wordle-users");
    const d=await r.json();
    const users=(d.users||[]).filter(u=>u.toLowerCase()!=="guest");
    const frag=document.createDocumentFragment();
    users.forEach(u=>{
      const btn=document.createElement("button");
      btn.className="uchip";
      btn.textContent=u.toUpperCase();
      btn.addEventListener("click",()=>{
        input.value=u.toUpperCase();
        showUserWarning(current,u.toLowerCase());
      });
      frag.appendChild(btn);
    });
    // Divider + GUEST chip always at the bottom.
    if(users.length){
      const hr=document.createElement("hr");
      hr.id="user-divider";
      frag.appendChild(hr);
    }
    const guestBtn=document.createElement("button");
    guestBtn.className="uchip guest";
    guestBtn.textContent="GUEST";
    guestBtn.addEventListener("click",()=>{
      input.value="GUEST";
      showUserWarning(current,"guest");
    });
    frag.appendChild(guestBtn);
    chips.appendChild(frag);
  }catch(e){
    // Silently ignore — user can still type a name.
  }
}

function showUserWarning(oldName,newName){
  const w=document.getElementById("user-warning");
  if(oldName && oldName.toLowerCase()!==newName.toLowerCase()){
    w.textContent="Existing games saved under "+oldName.toUpperCase()+" won't be moved.";
  } else {
    w.textContent="";
  }
}

function closeUserModal(){
  document.getElementById("user-modal").classList.remove("open");
}

// ── Theme ─────────────────────────────────────────────────────────────────────
const THEME_DEFAULTS={correct:"#6aaa64",present:"#c9b458",absent:"#3a3a3c"};
const THEME_KEY="wordle_theme";

function applyTheme(colors){
  const r=document.documentElement.style;
  r.setProperty("--clr-correct",colors.correct);
  r.setProperty("--clr-present",colors.present);
  r.setProperty("--clr-absent",colors.absent);
}

function loadTheme(){
  try{
    const saved=JSON.parse(localStorage.getItem(THEME_KEY));
    if(saved) applyTheme({...THEME_DEFAULTS,...saved});
  }catch(_){}
}

function getThemeDraft(){
  return{
    correct:document.getElementById("thm-correct").value,
    present:document.getElementById("thm-present").value,
    absent:document.getElementById("thm-absent").value
  };
}

function populateThemePickers(){
  // Load currently saved colors (or defaults) into the pickers.
  let saved={...THEME_DEFAULTS};
  try{const s=JSON.parse(localStorage.getItem(THEME_KEY));if(s) saved={...saved,...s};}catch(_){}
  document.getElementById("thm-correct").value=saved.correct;
  document.getElementById("thm-present").value=saved.present;
  document.getElementById("thm-absent").value=saved.absent;
}

// Real-time preview: update the right swatch's border so user sees the picked color clearly.
["thm-correct","thm-present","thm-absent"].forEach(id=>{
  document.getElementById(id).addEventListener("input",function(){
    this.style.outline="2px solid "+this.value;
  });
});

document.getElementById("theme-restore").addEventListener("click",()=>{
  document.getElementById("thm-correct").value=THEME_DEFAULTS.correct;
  document.getElementById("thm-present").value=THEME_DEFAULTS.present;
  document.getElementById("thm-absent").value=THEME_DEFAULTS.absent;
  // Clear outlines.
  ["thm-correct","thm-present","thm-absent"].forEach(id=>{
    document.getElementById(id).style.outline="";
  });
});

loadTheme();
// ─────────────────────────────────────────────────────────────────────────────

function saveUsername(){
  const raw=document.getElementById("user-input").value.trim().toLowerCase();
  if(!raw){
    document.getElementById("user-warning").textContent="Please enter a name.";
    return;
  }
  localStorage.setItem("wordle_username",raw);
  // Save theme.
  const theme=getThemeDraft();
  localStorage.setItem(THEME_KEY,JSON.stringify(theme));
  applyTheme(theme);
  closeUserModal();
  // Ensure background heartbeat is running (first-time users won't have it yet).
  mpLoadAbly().then(()=>{ mpSubscribeLobby(); mpStartBgHeartbeat(); }).catch(()=>{});
  // Refresh stats if the stats page is open.
  if(document.getElementById("stats-page").classList.contains("visible")){
    loadStats();
  }
}

document.getElementById("user-input").addEventListener("input",function(){
  const current=getUsername();
  showUserWarning(current,this.value.trim().toLowerCase());
});
document.getElementById("user-input").addEventListener("keydown",function(e){
  if(e.key==="Enter") saveUsername();
});
document.getElementById("user-save").addEventListener("click",saveUsername);
document.getElementById("stats-gear").addEventListener("click",openUserModal);
document.getElementById("gear-btn").addEventListener("click",()=>{
  populateThemePickers();
  openUserModal();
});

document.getElementById("stats-btn").addEventListener("click",()=>{
  document.getElementById("stats-page").classList.add("visible");
  loadStats();
});
document.getElementById("stats-back").addEventListener("click",()=>{
  document.getElementById("stats-page").classList.remove("visible");
});

// ── Multiplayer ──────────────────────────────────────────────────────────────

const MP_TIMEOUT_MS=10*60*1000;
const MP_ABLY_KEY="ojJiew.TwVtNg:Cb6XcfElKgIpu-yNqlWVv3-ayRWw2vjo2JTH2w43mKk";
const MP_HEARTBEAT_URL="/api/mp-heartbeat";
const MP_ROOM_URL="/api/mp-room";

let mpRoomId=null;
let mpRole=null;
let mpWinReported=false;
let mpGameTimer=null;
let mpHeartbeatTimer=null;
let mpLobbyRefreshTimer=null;
let mpSelectedPlayers=new Set();
let mpPendingInvites=[]; // [{host,room_id}]
let mpAblyClient=null;
let mpLobbyChannel=null;
let mpRoomChannel=null;
let mpLastRematch=null; // {players:[]} for rematch

// ── Ably ─────────────────────────────────────────────────────────────────────
function mpGetAbly(){
  if(!mpAblyClient){
    mpAblyClient=new Ably.Realtime({key:MP_ABLY_KEY});
  }
  return mpAblyClient;
}

function mpSubscribeLobby(){
  if(mpLobbyChannel) return;
  mpLobbyChannel=mpGetAbly().channels.get("wordle-lobby");
  mpLobbyChannel.subscribe("lobby-update",()=>{
    // Only refresh the visible list if the modal is currently open.
    if(document.getElementById("mp-modal").classList.contains("open")) mpLoadLobbyPlayers();
  });
  mpLobbyChannel.subscribe("invite",(msg)=>{
    const d=JSON.parse(msg.data);
    if(d.invitee===getUsername().toLowerCase()){
      mpPendingInvites.push({host:d.host,room_id:d.room_id});
      mpSubscribeRoom(d.room_id);
      // If the winner modal is showing (e.g. player is on the rematch screen),
      // dismiss it first so the invite banner is immediately visible.
      if(document.getElementById("mp-win-modal").classList.contains("open")){
        mpCloseWinModal();
      }
      const modal=document.getElementById("mp-modal");
      if(!modal.classList.contains("open")){
        openMpModal();
      }else{
        mpRenderInvitations();
      }
    }
  });
}

function mpUnsubscribeLobby(){
  if(mpLobbyChannel){mpLobbyChannel.unsubscribe();mpLobbyChannel=null;}
}

function mpSubscribeRoom(roomId){
  if(mpRoomChannel) mpRoomChannel.unsubscribe();
  mpRoomChannel=mpGetAbly().channels.get("wordle-room-"+roomId);
  mpRoomChannel.subscribe("player-status",(msg)=>{
    const d=JSON.parse(msg.data);
    if(mpRole==="host") mpRenderWaitList(d.players);
    else mpUpdateStartReady(d.players);
  });
  mpRoomChannel.subscribe("game-start",(msg)=>{
    const d=JSON.parse(msg.data);
    // Store everyone else in this game so any player can initiate a rematch.
    const me=getUsername().toLowerCase();
    mpLastRematch={players:(d.players||[]).filter(p=>p!==me)};
    mpStartGame(d.target_word,d.room_id);
  });
  mpRoomChannel.subscribe("player-won",(msg)=>{
    const d=JSON.parse(msg.data);
    const iWon=(d.winner===getUsername().toLowerCase());
    mpShowWinModal(iWon,d.winner,d.target_word,d.guesses_count);
  });
  mpRoomChannel.subscribe("room-abandoned",(msg)=>{
    const d=JSON.parse(msg.data||"{}");
    const abandonedRoom=d.room_id||roomId;
    if(mpRoomId&&mpRoomId===abandonedRoom){
      // Player had already accepted — close the game.
      mpRoomId=null;
      mpRole=null;
      clearTimeout(mpGameTimer);
      mpUnsubscribeRoom();
      updateGearBtn();
      showMessage("Host cancelled the game",2500);
      mpShowView("lobby");
      document.getElementById("mp-modal").classList.add("open");
      initGame();
    }else{
      // Player had not yet accepted — remove the invite banner and unsubscribe.
      mpPendingInvites=mpPendingInvites.filter(inv=>inv.room_id!==abandonedRoom);
      mpUnsubscribeRoom();
      if(document.getElementById("mp-modal").classList.contains("open")){
        mpRenderInvitations();
      }
    }
  });
}

function mpUnsubscribeRoom(){
  if(mpRoomChannel){mpRoomChannel.unsubscribe();mpRoomChannel=null;}
}

// ── Lobby ─────────────────────────────────────────────────────────────────────
async function mpLoadAbly(){
  return new Promise((resolve,reject)=>{
    if(window.Ably){resolve();return;}
    const s=document.createElement("script");
    s.src="https://cdn.ably.com/lib/ably.min-2.js";
    s.onload=resolve;s.onerror=reject;
    document.head.appendChild(s);
  });
}

async function openMpModal(){
  await mpLoadAbly();
  const u=getUsername();
  if(!u){openUserModal();return;}
  // Don't reset pending invites here — they may have arrived before the modal opened.
  mpSelectedPlayers.clear();
  mpShowView("lobby");
  document.getElementById("mp-modal").classList.add("open");
  // Heartbeat is already running in background; just start the lobby list refresh.
  mpStartLobbyRefresh();
  mpSubscribeLobby();
  mpRenderInvitations();
  await mpLoadLobbyPlayers();
}

function closeMpModal(){
  document.getElementById("mp-modal").classList.remove("open");
  mpStopLobbyRefresh();
  // Do NOT unsubscribe from lobby — keep it alive so future invites arrive
  // even when the modal is closed.
  if(!mpRoomId) mpUnsubscribeRoom();
}

// ── Background heartbeat (runs whenever app is in foreground) ─────────────────
function mpStartBgHeartbeat(){
  if(mpHeartbeatTimer) return; // already running
  mpSendHeartbeat();
  mpHeartbeatTimer=setInterval(mpSendHeartbeat,5000);
}

function mpStopBgHeartbeat(){
  clearInterval(mpHeartbeatTimer);
  mpHeartbeatTimer=null;
}

// Pause when tab/app goes to background, resume when it comes back.
document.addEventListener("visibilitychange",()=>{
  if(document.hidden){
    mpStopBgHeartbeat();
  }else{
    if(getUsername()) mpStartBgHeartbeat();
  }
});

// ── Lobby list refresh (only while modal is open) ─────────────────────────────
function mpStartLobbyRefresh(){
  mpLobbyRefreshTimer=setInterval(mpLoadLobbyPlayers,10000);
}

function mpStopLobbyRefresh(){
  clearInterval(mpLobbyRefreshTimer);
  mpLobbyRefreshTimer=null;
}

async function mpSendHeartbeat(){
  const u=getUsername();
  if(!u) return;
  try{
    await fetch(MP_HEARTBEAT_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username:u,difficulty:getDifficulty()})
    });
  }catch(_){}
}

async function mpLoadLobbyPlayers(){
  try{
    const r=await fetch(MP_HEARTBEAT_URL);
    const d=await r.json();
    const me=getUsername().toLowerCase();
    const others=(d.players||[]).filter(p=>p.username!==me);
    const statusEl=document.getElementById("mp-lobby-status");
    const secEl=document.getElementById("mp-sec-online");
    const listEl=document.getElementById("mp-lobby-list");
    listEl.innerHTML="";
    if(!others.length){
      statusEl.style.display="block";
      statusEl.textContent="No other players found.";
      secEl.style.display="none";
    }else{
      statusEl.style.display="none";
      secEl.style.display="block";
      const stLabel={available:"Available",playing:"In game",offline:"Offline"};
      const diffLabel={easy:"E",normal:"N",hard:"H",superhard:"SH"};
      others.forEach(({username:p,status,difficulty})=>{
        const avail=status==="available";
        const diff=difficulty||"normal";
        const badge=diffLabel[diff]||"N";
        const row=document.createElement("div");
        row.className="mp-prow"+(avail&&mpSelectedPlayers.has(p)?" sel":"")+(avail?"":" unavail");
        row.dataset.player=p;
        row.innerHTML=`
          <div class="mp-prow-left">
            <span class="mp-dot ${status}"></span>
            <span class="mp-prow-name">${p.toUpperCase()}</span>
            <span class="mp-diff-badge ${diff}">${badge}</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="mp-prow-st">${stLabel[status]||status}</span>
            <span class="mp-prow-chk">✓</span>
          </div>`;
        if(avail){
          row.addEventListener("click",()=>{
            if(mpSelectedPlayers.has(p)) mpSelectedPlayers.delete(p);
            else mpSelectedPlayers.add(p);
            row.classList.toggle("sel",mpSelectedPlayers.has(p));
            document.getElementById("mp-invite-btn").disabled=mpSelectedPlayers.size===0;
          });
        }
        listEl.appendChild(row);
      });
    }
    document.getElementById("mp-invite-btn").disabled=mpSelectedPlayers.size===0;
  }catch(_){}
}

function mpRenderInvitations(){
  const area=document.getElementById("mp-inv-area");
  area.innerHTML="";
  mpPendingInvites.forEach((inv,idx)=>{
    const banner=document.createElement("div");
    banner.className="mp-inv-banner";
    banner.innerHTML=`<div class="mp-inv-text">${inv.host.toUpperCase()} invited you!</div>
<div class="mp-inv-row">
  <button class="mp-acc-btn">ACCEPT</button>
  <button class="mp-dec-btn">DECLINE</button>
</div>`;
    banner.querySelector(".mp-acc-btn").addEventListener("click",()=>mpAcceptInvite(inv,idx));
    banner.querySelector(".mp-dec-btn").addEventListener("click",()=>mpDeclineInvite(inv,idx));
    area.appendChild(banner);
  });
}

async function mpAcceptInvite(inv,idx){
  mpPendingInvites.splice(idx,1);
  mpRenderInvitations();
  mpRoomId=inv.room_id;
  mpRole="player";
  document.getElementById("mp-accepted-msg").textContent=`Waiting for ${inv.host.toUpperCase()} to start the game...`;
  mpShowView("accepted");
  mpSubscribeRoom(inv.room_id);
  try{
    await fetch(MP_ROOM_URL,{
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"accept",room_id:inv.room_id,username:getUsername()})
    });
  }catch(_){}
}

async function mpDeclineInvite(inv,idx){
  mpPendingInvites.splice(idx,1);
  mpRenderInvitations();
  try{
    await fetch(MP_ROOM_URL,{
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"decline",room_id:inv.room_id,username:getUsername()})
    });
  }catch(_){}
}

// ── Waiting room (host) ───────────────────────────────────────────────────────
async function mpInvitePlayers(){
  if(!mpSelectedPlayers.size) return;
  const username=getUsername();
  const invitees=[...mpSelectedPlayers];
  mpLastRematch={players:invitees};
  try{
    const r=await fetch(MP_ROOM_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username,invitees})
    });
    const d=await r.json();
    mpRoomId=d.room_id;
    mpRole="host";
    mpSubscribeRoom(mpRoomId);
    mpRenderWaitList([
      {username:username.toLowerCase(),role:"host",status:"accepted"},
      ...invitees.map(p=>({username:p,role:"player",status:"invited"}))
    ]);
    mpShowView("waiting");
  }catch(e){
    showMessage("Could not create game room",2000);
  }
}

function mpRenderWaitList(players){
  const list=document.getElementById("mp-wait-list");
  list.innerHTML="";
  let acceptedCount=0;
  players.forEach(p=>{
    const row=document.createElement("div");
    row.className="mp-wrow";
    const stMap={accepted:"ok",invited:"wait",playing:"ok",won:"ok",declined:"no"};
    const stLabel={accepted:"✓ Ready",invited:"Waiting...",playing:"Playing",won:"Won",declined:"Declined"};
    const cls=stMap[p.status]||"wait";
    const lbl=stLabel[p.status]||p.status;
    const hostBadge=p.role==="host"?" (HOST)":"";
    row.innerHTML=`<span class="mp-wrow-name">${p.username.toUpperCase()}${hostBadge}</span><span class="mp-wst ${cls}">${lbl}</span>`;
    list.appendChild(row);
    if(p.status==="accepted"&&p.role!=="host") acceptedCount++;
  });
  document.getElementById("mp-start-btn").disabled=acceptedCount===0;
}

function mpUpdateStartReady(players){
  // For the accepted (non-host) view, just update the accepted-msg text.
  const allReady=players.every(p=>p.status==="accepted"||p.role==="host");
  document.getElementById("mp-accepted-msg").textContent=
    allReady?"All players ready! Waiting for host to start...":"Waiting for all players to accept...";
}

async function mpCancelRoom(){
  if(mpRoomId){
    try{
      await fetch(MP_ROOM_URL,{
        method:"PATCH",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"abandon",room_id:mpRoomId,username:getUsername()})
      });
    }catch(_){}
    mpRoomId=null;
    mpRole=null;
    mpUnsubscribeRoom();
  }
  mpSelectedPlayers.clear();
  mpShowView("lobby");
  await mpLoadLobbyPlayers();
}

async function mpStartRound(){
  if(!mpRoomId) return;
  const word=WORDS[Math.floor(Math.random()*WORDS.length)];
  try{
    await fetch(MP_ROOM_URL,{
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"start",room_id:mpRoomId,username:getUsername(),target_word:word})
    });
  }catch(e){
    showMessage("Could not start game",2000);
  }
}

// ── Game flow ─────────────────────────────────────────────────────────────────
function mpStartGame(word,roomId){
  mpRoomId=roomId;
  updateGearBtn();
  document.getElementById("mp-modal").classList.remove("open");
  mpStopLobbyRefresh();
  // Keep lobby subscription and heartbeat alive — heartbeat keeps us showing
  // as "playing" (via the DB room status), and lobby stays ready for future invites.
  initGame({word,multiplayer:true});
}

async function mpReportWin(guessesCount){
  if(mpWinReported) return;
  mpWinReported=true;
  clearTimeout(mpGameTimer);
  try{
    await fetch(MP_ROOM_URL,{
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"win",room_id:mpRoomId,username:getUsername(),guesses_count:guessesCount})
    });
  }catch(_){}
  // The server publishes player-won via Ably; our own subscription will show the modal.
}

function mpTimeout(){
  if(!mpRoomId) return;
  fetch(MP_ROOM_URL,{
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"abandon",room_id:mpRoomId,username:getUsername()})
  }).catch(()=>{});
  mpRoomId=null;mpRole=null;
  mpUnsubscribeRoom();
  updateGearBtn();
  initGame();
}

// ── Winner modal ──────────────────────────────────────────────────────────────
function mpShowWinModal(iWon,winner,word,guessCount){
  clearTimeout(mpGameTimer);
  gameOver=true;
  const card=document.getElementById("mp-win-card");
  card.className=iWon?"":"loss";
  document.getElementById("mp-win-trophy").textContent=iWon?"🏆":"";
  document.getElementById("mp-win-name").textContent=iWon?"YOU WIN!":`${winner.toUpperCase()} WINS!`;
  document.getElementById("mp-win-word").textContent=`The word was ${word.toUpperCase()}`;
  document.getElementById("mp-win-sub").textContent=iWon?`Solved in ${guessCount} guess${guessCount!==1?"es":""}!`:"Better luck next time!";
  document.getElementById("mp-win-modal").classList.add("open");
}

function mpCloseWinModal(){
  document.getElementById("mp-win-modal").classList.remove("open");
  mpRoomId=null;mpRole=null;mpWinReported=false;
  mpUnsubscribeRoom();
  updateGearBtn();
}

// ── View switcher ─────────────────────────────────────────────────────────────
function mpShowView(name){
  ["lobby","waiting","accepted"].forEach(v=>{
    document.getElementById("mp-v-"+v).style.display=(v===name?"flex":"none");
  });
  // Lobby view uses flex column already; force block for containing divs.
  document.getElementById("mp-v-"+name).style.display="";
}

// ── Event listeners ───────────────────────────────────────────────────────────
document.getElementById("mp-btn").addEventListener("click",openMpModal);
document.getElementById("mp-close-btn").addEventListener("click",closeMpModal);
document.getElementById("mp-bd").addEventListener("click",closeMpModal);
document.getElementById("mp-invite-btn").addEventListener("click",mpInvitePlayers);
document.getElementById("mp-cancel-btn").addEventListener("click",mpCancelRoom);
document.getElementById("mp-start-btn").addEventListener("click",mpStartRound);
document.getElementById("mp-win-rematch").addEventListener("click",async()=>{
  const lastPlayers=mpLastRematch?[...mpLastRematch.players]:[];
  mpCloseWinModal();
  await openMpModal();
  if(lastPlayers.length){
    // Whoever taps REMATCH first becomes the new host and invites everyone.
    // If another player already sent the invite, it will arrive as a banner.
    lastPlayers.forEach(p=>mpSelectedPlayers.add(p));
    await mpInvitePlayers();
  }
});
document.getElementById("mp-win-close").addEventListener("click",()=>{
  mpCloseWinModal();
  initGame();
});

initGame();
trySyncPendingGames();

// Auto-prompt for username on load if none stored.
if(!getUsername()){
  openUserModal();
}else{
  // Background Ably subscription + heartbeat so the user appears green
  // in others' lobbies whenever the app is in the foreground.
  mpLoadAbly().then(()=>{
    mpSubscribeLobby();
    mpStartBgHeartbeat();
  }).catch(()=>{});
}
</script>
</body>
</html>